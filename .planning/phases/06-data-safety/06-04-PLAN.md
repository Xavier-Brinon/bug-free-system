---
phase: 06-data-safety
plan: "04"
type: execute
wave: 2
depends_on: ["06-02", "06-03"]
files_modified:
  - src/machines/appMachine.ts
  - tests/unit/appMachine.test.ts
  - src/newtab/App.tsx
  - src/newtab/App.css
  - src/newtab/App.stories.tsx
  - src/components/DataManager.stories.tsx
  - tests/e2e/newtab.spec.ts
autonomous: true
requirements:
  - DATA-01
  - DATA-02
  - DATA-03

must_haves:
  truths:
    - "appMachine gains ready.viewingData substate for the data management view"
    - "VIEW_DATA event navigates from ready.viewing to ready.viewingData"
    - "BACK_TO_DASHBOARD event navigates from ready.viewingData to ready.viewing"
    - "IMPORT_VALIDATED event stores importPreview in context"
    - "IMPORT_FAILED event stores importError in context"
    - "IMPORT_COMPLETE event clears importPreview and returns to viewingData"
    - "CLEAR_IMPORT_ERROR event clears importError"
    - "App.tsx renders DataManager in viewingData state"
    - "Export handler loads data, converts to JSON, triggers download"
    - "Import handler reads file, validates, shows preview or error"
    - "Confirm import: downloads backup, writes imported data, invalidates queries"
    - "Dashboard has a 'Data' navigation button"
    - "Storybook stories exist for DataManager and App data states"
    - "Playwright E2E tests verify export, import with valid file, import with invalid file"
  artifacts:
    - path: "src/machines/appMachine.ts"
      provides: "Extended with viewingData substate and import flow events"
    - path: "tests/unit/appMachine.test.ts"
      provides: "Unit tests for new data-related state transitions"
    - path: "src/newtab/App.tsx"
      provides: "Data view and export/import flows wired into the app"
    - path: "src/newtab/App.css"
      provides: "Styles for data management view"
    - path: "src/newtab/App.stories.tsx"
      provides: "Stories for App in viewingData state"
    - path: "src/components/DataManager.stories.tsx"
      provides: "Storybook stories for DataManager component"
    - path: "tests/e2e/newtab.spec.ts"
      provides: "E2E tests for export, import, and error handling"
  key_links:
    - from: "src/newtab/App.tsx"
      to: "src/components/DataManager.tsx"
      via: "Renders DataManager in viewingData state"
    - from: "src/newtab/App.tsx"
      to: "src/data-safety.ts"
      via: "Uses exportToJson, parseImportFile, triggerDownload, filename generators"
    - from: "src/newtab/App.tsx"
      to: "src/machines/appMachine.ts"
      via: "Uses new data-related events and states"
    - from: "src/newtab/App.tsx"
      to: "src/storage.ts"
      via: "Uses loadBookTabData and saveBookTabData for export/import"
---

<objective>
Wire the DataManager component into the app by extending the appMachine with
data management states and integrating export/import flows into App.tsx. Add
Storybook stories and Playwright E2E tests.

Purpose: This plan completes DATA-01, DATA-02, and DATA-03 by connecting the
DataManager component to the state machine, data-safety utilities, and storage
layer. Users can navigate to a data management view, export their library as
JSON, import a previously exported file with validation and confirmation, and
receive an automatic backup before any import overwrites their data.

Output:
- Extended appMachine with viewingData state and import flow events
- Unit tests for new state transitions
- App.tsx integration with export/import flows
- CSS styles for data management view
- Storybook stories for DataManager and App data states
- Playwright E2E tests for export/import workflows
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@src/machines/appMachine.ts
@tests/unit/appMachine.test.ts
@src/newtab/App.tsx
@src/newtab/App.css
@src/newtab/App.stories.tsx
@src/data-safety.ts
@src/components/DataManager.tsx
@tests/e2e/newtab.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend appMachine with data management states (TDD, unit tests)</name>
  <files>src/machines/appMachine.ts
tests/unit/appMachine.test.ts</files>
  <action>
Write unit tests first, then implementation. Follow TDD red-green-refactor.

New states and events for appMachine:
  - ready.viewingData â€” shows the data management view (DataManager)

New events:
  - VIEW_DATA: ready.viewing -> ready.viewingData
  - BACK_TO_DASHBOARD: ready.viewingData -> ready.viewing (already exists for queue, reuse from viewingData)
  - IMPORT_VALIDATED: stores importPreview in context (stays in viewingData)
  - IMPORT_FAILED: stores importError in context (stays in viewingData)
  - IMPORT_COMPLETE: clears importPreview (stays in viewingData)
  - CLEAR_IMPORT_ERROR: clears importError (stays in viewingData)

Context additions:
  - importError: string | null
  - importPreview: { bookCount: number } | null

Test 1 (RED): VIEW_DATA transitions from ready.viewing to ready.viewingData
  -> Add viewingData substate and VIEW_DATA event (GREEN)

Test 2 (RED): BACK_TO_DASHBOARD transitions from ready.viewingData to ready.viewing
  -> Add BACK_TO_DASHBOARD event on viewingData (GREEN)

Test 3 (RED): IMPORT_VALIDATED stores importPreview in context
  -> Add IMPORT_VALIDATED event with assign action (GREEN)

Test 4 (RED): IMPORT_FAILED stores importError in context
  -> Add IMPORT_FAILED event with assign action (GREEN)

Test 5 (RED): IMPORT_COMPLETE clears importPreview
  -> Add IMPORT_COMPLETE event with assign action (GREEN)

Test 6 (RED): CLEAR_IMPORT_ERROR clears importError
  -> Add CLEAR_IMPORT_ERROR event with assign action (GREEN)

Refactor: ensure clean types, consistent with existing appMachine patterns.
  </action>
  <verify>
    <automated>npm run test -- --project unit</automated>
  </verify>
  <done>appMachine has viewingData substate and import flow events; all unit tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Wire DataManager into App.tsx with export/import flows</name>
  <files>src/newtab/App.tsx
src/newtab/App.css</files>
  <action>
Integrate DataManager into the App component with full export/import flows.

1. Import DataManager, data-safety utilities
2. Add handleExport callback:
   - loadBookTabData() to get current data
   - exportToJson(data) to create JSON string
   - triggerDownload(json, generateExportFilename()) to download
3. Add handleFileSelected callback:
   - parseImportFile(content) to validate
   - If invalid: send IMPORT_FAILED with error message
   - If valid: send IMPORT_VALIDATED with { bookCount: Object.keys(data.books).length }
   - Store validated data in a ref for use on confirm
4. Add handleConfirmImport callback:
   - loadBookTabData() to get current data for backup
   - exportToJson(currentData) to create backup JSON
   - triggerDownload(backupJson, generateBackupFilename()) to download backup
   - saveBookTabData(importedData) to write imported data
   - queryClient.invalidateQueries() to refresh UI
   - Reinitialize libraryMachine actor with new books
   - send IMPORT_COMPLETE
5. Add handleCancelImport callback:
   - Clear importPreview and any stored import data
6. In ready.viewing, add a "Data" button -> sends VIEW_DATA
7. Add ready.viewingData render:
   - Shows "Your Data" heading
   - "Back to Dashboard" button -> sends BACK_TO_DASHBOARD
   - Renders DataManager with:
     - onExport={handleExport}
     - onFileSelected={handleFileSelected}
     - onConfirmImport={handleConfirmImport}
     - onCancelImport={handleCancelImport}
     - importError={state.context.importError}
     - importPreview={state.context.importPreview}
     - currentBookCount={Object.keys(books).length}
8. Add CSS styles for data management view (.data-view class, .import-error, .import-preview)
  </action>
  <verify>
    <automated>npm run build && npm run lint && npm run fmt:check</automated>
  </verify>
  <done>App renders data management view; export downloads JSON; import validates, previews, backs up, and writes; builds cleanly</done>
</task>

<task type="auto">
  <name>Task 3: Storybook stories for DataManager and App data states</name>
  <files>src/components/DataManager.stories.tsx
src/newtab/App.stories.tsx</files>
  <action>
Add Storybook stories following existing patterns.

DataManager stories:
  - Default: clean state, no error, no preview, 5 books in library
  - WithImportError: validation error message displayed
  - WithImportPreview: confirmation step showing "replace 5 books with 3 books"
  - EmptyLibrary: 0 books, export still available

App stories (add to existing file):
  - DataView: App in ready.viewingData state with some books
  </action>
  <verify>
    <automated>npm run test -- --project storybook</automated>
  </verify>
  <done>All new Storybook stories render correctly; storybook tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Playwright E2E tests for export/import workflows</name>
  <files>tests/e2e/newtab.spec.ts</files>
  <action>
Add E2E tests to the existing newtab.spec.ts file.

Test 1: User can navigate to data view and back
  - Click "Data" button on dashboard
  - Verify "Your Data" heading visible
  - Click "Back to Dashboard"
  - Verify dashboard is visible again

Test 2: User can export library data
  - Add a book first
  - Navigate to data view
  - Click "Export Library"
  - Verify download was triggered (use Playwright's download event listener)
  - Verify downloaded file contains valid JSON with the book data

Test 3: User can import valid data
  - Start with empty library
  - Navigate to data view
  - Upload a valid BookTabData JSON file via file input
  - Verify preview shows book count
  - Click "Confirm Import"
  - Verify backup download triggered
  - Navigate back to dashboard
  - Verify imported books appear

Test 4: Import with invalid file shows error
  - Navigate to data view
  - Upload an invalid JSON file
  - Verify error message is displayed
  - Navigate back to dashboard
  - Verify existing data is untouched
  </action>
  <verify>
    <automated>npm run e2e</automated>
  </verify>
  <done>E2E tests pass for data navigation, export, import with valid data, import with invalid data</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint && npm run fmt:check` pass
2. `npm run test` passes all tests (unit + browser + storybook)
3. `npm run build` succeeds
4. `npm run e2e` passes all E2E tests
5. User can navigate to data view from dashboard
6. Export downloads complete library as JSON
7. Import validates file and shows preview
8. Confirm import creates backup and replaces data
9. Invalid files show error without affecting existing data
</verification>

<success_criteria>
- Full DATA-01: Export creates downloadable JSON with all library data
- Full DATA-02: Import restores library from valid JSON; invalid files rejected with clear error
- Full DATA-03: Auto-backup downloaded before import overwrites data
- Explicit confirmation step with book count comparison
- TDD red-green-refactor followed throughout
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-safety/06-04-SUMMARY.md` using the summary template.
</output>
