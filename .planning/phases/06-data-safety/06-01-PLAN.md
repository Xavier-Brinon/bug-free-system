---
phase: 06-data-safety
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/decisions/0010-json-schema.org
autonomous: true
requirements:
  - DATA-01
  - DATA-02
  - DATA-03
  - DEV-05

must_haves:
  truths:
    - "Phase starts with a tidy-up commit (DEV-05) before any new work"
    - "ADR-0010 documents the versioned JSON export schema before implementation"
    - "Export format is the full BookTabData object, pretty-printed JSON"
    - "Import validation uses bookTabDataSchema.safeParse()"
    - "schemaVersion field enables future migrations"
    - "Import flow includes explicit confirmation and auto-backup"
    - "ADR includes Mermaid diagram for the import flow"
  artifacts:
    - path: "docs/decisions/0010-json-schema.org"
      provides: "ADR documenting the versioned JSON export/import schema and strategy"
  key_links:
    - from: "docs/decisions/0010-json-schema.org"
      to: "src/schema.ts"
      via: "Documents the bookTabDataSchema already defined in schema.ts"
    - from: "docs/decisions/0010-json-schema.org"
      to: "src/data-safety.ts (Plan 06-02)"
      via: "Informs the export/import utility implementation"
---

<objective>
Start Phase 6 with mandatory tidy-up, then write ADR-0010 documenting the
versioned JSON export/import schema before any implementation begins.

Purpose: ADR-02 requires an ADR before every architecturally significant
decision. The export/import schema format, validation strategy, and migration
path are critical design decisions that must be documented before code is written.

Output:
- Tidy-up commit (or confirmation no changes needed)
- docs/decisions/0010-json-schema.org â€” ADR for versioned JSON export schema
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@.planning/ROADMAP.org
@src/schema.ts
@src/storage.ts
@docs/decisions/0000-template.org
@docs/decisions/0008-storage-local.org
</context>

<tasks>

<task type="auto">
  <name>Task 1: Phase 6 tidy-up</name>
  <files></files>
  <action>
Mandatory tidy-up before new feature code (DEV-05):

1. Run `npm run lint` and fix any warnings
2. Run `npm run fmt:check` and fix any formatting issues
3. Run `npm test` and confirm all 124 tests pass
4. Review existing code for dead imports, unused variables, inconsistent naming
5. Commit tidy-up changes (if any) as a separate commit
  </action>
  <verify>
    <automated>npm run lint && npm run fmt:check && npm test</automated>
  </verify>
  <done>Codebase is clean; lint, format, and tests all pass; tidy-up commit created (or no changes needed)</done>
</task>

<task type="auto">
  <name>Task 2: Write ADR-0010 (Versioned JSON export schema)</name>
  <files>docs/decisions/0010-json-schema.org</files>
  <action>
Write ADR-0010 following the MADR 4.0 template (org-mode format).

Key decisions to document:
1. Export format: full BookTabData object serialized as pretty-printed JSON
   - Contains schemaVersion, books (all records), and settings
   - Human-readable and re-importable without modification
2. Download mechanism: Blob + URL.createObjectURL + programmatic anchor click
   - No browser.downloads API (avoids extra permission)
3. Import validation: bookTabDataSchema.safeParse() from Zod
   - Invalid files rejected with user-friendly error messages
   - Existing library never touched on validation failure
4. Auto-backup before import: current library auto-downloaded as backup file
   before any overwrite (DATA-03)
5. Explicit confirmation: user sees preview (book count comparison) and must
   confirm before import proceeds
6. Schema versioning: schemaVersion field enables future migrations
   - Migration functions can be chained: v1->v2->v3
   - Each migration is a pure function transforming the data shape
7. File naming: booktab-export-YYYY-MM-DD.json / booktab-backup-YYYY-MM-DD.json

Include Mermaid diagram showing the import flow:
  User selects file -> parse JSON -> validate schema -> show preview ->
  user confirms -> download backup -> overwrite storage -> invalidate queries -> success

Considered options:
- Full BookTabData export (chosen)
- Books-only export (rejected: loses settings and schema version)
- Custom export format (rejected: unnecessary complexity)
  </action>
  <verify>
    <automated>test -f docs/decisions/0010-json-schema.org && echo "ADR exists"</automated>
  </verify>
  <done>ADR-0010 written with export format, validation strategy, migration path, backup strategy, and Mermaid import flow diagram</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint && npm run fmt:check` pass
2. `npm run test` passes all 124 tests
3. docs/decisions/0010-json-schema.org exists and follows MADR 4.0 structure
4. ADR documents export format, import validation, auto-backup, and migration strategy
5. Mermaid diagram illustrates the import flow
</verification>

<success_criteria>
- ADR-0010 written before any export/import code (ADR-02 compliance)
- Export format, validation, backup, and migration strategies documented
- Tidy-up confirms clean codebase before Phase 6 work begins
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-safety/06-01-SUMMARY.md` using the summary template.
</output>
