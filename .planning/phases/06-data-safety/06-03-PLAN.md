---
phase: 06-data-safety
plan: "03"
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - src/components/DataManager.tsx
  - tests/browser/DataManager.test.tsx
autonomous: true
requirements:
  - DATA-01
  - DATA-02
  - DATA-03

must_haves:
  truths:
    - "DataManager component renders Export button that calls onExport callback"
    - "DataManager component renders file input that accepts .json files only"
    - "DataManager shows validation error message when importError prop is set"
    - "DataManager shows import preview with book count when importPreview prop is set"
    - "DataManager shows Confirm Import button only when preview is available"
    - "DataManager shows current library book count for comparison"
    - "DataManager calls onFileSelected callback with file content string"
    - "DataManager calls onConfirmImport callback when user confirms"
    - "All component logic written via TDD: browser tests first, implementation second"
    - "Tests exercise public interfaces only — no internal mocking"
  artifacts:
    - path: "src/components/DataManager.tsx"
      provides: "Export/import UI component with validation feedback and confirmation"
    - path: "tests/browser/DataManager.test.tsx"
      provides: "Browser tests for DataManager rendering, interactions, and states"
  key_links:
    - from: "src/components/DataManager.tsx"
      to: "src/data-safety.ts"
      via: "App.tsx will use data-safety utilities when handling DataManager callbacks"
    - from: "src/components/DataManager.tsx"
      to: "src/newtab/App.tsx (Plan 06-04)"
      via: "App renders DataManager in viewingData state"
---

<objective>
Build the DataManager component that provides the export/import UI with
validation feedback and explicit confirmation step.

Purpose: This component is the user-facing surface for DATA-01 (export button),
DATA-02 (import file selection and confirmation), and DATA-03 (backup
messaging). It receives callbacks and state as props — all business logic
lives in App.tsx and the data-safety utilities.

Output:
- src/components/DataManager.tsx — export/import UI component
- tests/browser/DataManager.test.tsx — browser component tests
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@src/data-safety.ts
@src/schema.ts
@src/components/BookCard.tsx
@src/newtab/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export section with TDD (browser tests)</name>
  <files>src/components/DataManager.tsx
tests/browser/DataManager.test.tsx</files>
  <action>
Write browser tests first, then implementation. Follow TDD red-green-refactor.

DataManager props for export:
  - onExport: () => void
  - currentBookCount: number

Test 1 (RED): Renders Export button with label "Export Library"
  -> Create DataManager component with Export button (GREEN)

Test 2 (RED): Clicking Export button calls onExport callback
  -> Wire onClick to onExport prop (GREEN)

Test 3 (RED): Shows current library book count (e.g., "Your library has 5 books")
  -> Display currentBookCount prop (GREEN)
  </action>
  <verify>
    <automated>npm run test -- --project browser</automated>
  </verify>
  <done>DataManager export section renders and calls callback; browser tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Import file selection with TDD (browser tests)</name>
  <files>src/components/DataManager.tsx
tests/browser/DataManager.test.tsx</files>
  <action>
Write browser tests first, then implementation. Follow TDD red-green-refactor.

DataManager props for import:
  - onFileSelected: (content: string) => void

Test 1 (RED): Renders file input that accepts only .json files
  -> Add file input with accept=".json" (GREEN)

Test 2 (RED): Selecting a file triggers onFileSelected with file content
  -> Add onChange handler that reads file with FileReader and calls onFileSelected (GREEN)
  </action>
  <verify>
    <automated>npm run test -- --project browser</automated>
  </verify>
  <done>DataManager import file input works; browser tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Validation error display with TDD (browser tests)</name>
  <files>src/components/DataManager.tsx
tests/browser/DataManager.test.tsx</files>
  <action>
Write browser tests first, then implementation. Follow TDD red-green-refactor.

DataManager props for error:
  - importError: string | null

Test 1 (RED): Shows error message when importError is set
  -> Add conditional error display (GREEN)

Test 2 (RED): Does not show error section when importError is null
  -> Conditional rendering already handles this (GREEN)
  </action>
  <verify>
    <automated>npm run test -- --project browser</automated>
  </verify>
  <done>DataManager error display works; browser tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Import preview and confirmation with TDD (browser tests)</name>
  <files>src/components/DataManager.tsx
tests/browser/DataManager.test.tsx</files>
  <action>
Write browser tests first, then implementation. Follow TDD red-green-refactor.

DataManager props for confirmation:
  - importPreview: { bookCount: number } | null
  - currentBookCount: number (already used in export section)
  - onConfirmImport: () => void
  - onCancelImport: () => void

Test 1 (RED): Shows preview section when importPreview is set with book count comparison
  - e.g., "This will replace your 5 books with 3 books from the import file."
  -> Add conditional preview section (GREEN)

Test 2 (RED): Shows "Confirm Import" and "Cancel" buttons in preview
  -> Add confirm and cancel buttons (GREEN)

Test 3 (RED): Clicking Confirm Import calls onConfirmImport
  -> Wire onClick (GREEN)

Test 4 (RED): Clicking Cancel calls onCancelImport
  -> Wire onClick (GREEN)

Test 5 (RED): Does not show preview section when importPreview is null
  -> Conditional rendering handles this (GREEN)

Test 6 (RED): Preview mentions backup will be created
  - e.g., "A backup of your current data will be downloaded first."
  -> Add backup notice text (GREEN)
  </action>
  <verify>
    <automated>npm run test -- --project browser</automated>
  </verify>
  <done>DataManager confirmation flow works; browser tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint && npm run fmt:check` pass
2. `npm run test` passes all tests (existing + new browser tests)
3. `npm run build` succeeds
4. DataManager renders export button, file input, error display, and confirmation
5. All interactions trigger appropriate callbacks
6. All code written via TDD red-green-refactor
</verification>

<success_criteria>
- Export button is present and functional (DATA-01 UI)
- File input accepts .json files and reads content (DATA-02 UI)
- Validation errors displayed clearly (DATA-02 UX)
- Explicit confirmation with backup notice (DATA-03 UX)
- TDD red-green-refactor followed throughout
</success_criteria>

<output>
After completion, create `.planning/phases/06-data-safety/06-03-SUMMARY.md` using the summary template.
</output>
