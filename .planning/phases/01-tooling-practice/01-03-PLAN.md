---
phase: 01-tooling-practice
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - docs/decisions/0001-vitest.org
  - docs/decisions/images/0001-vitest-toolchain.svg
  - docs/decisions/0002-tdd.org
  - docs/decisions/images/0002-tdd-cycle.svg
autonomous: true
requirements:
  - DEV-02
  - DEV-03
  - DEV-04
  - DEV-06

must_haves:
  truths:
    - "An ADR exists documenting why Vitest was chosen over alternatives (Jest, Mocha, etc.)"
    - "An ADR exists documenting the TDD red-green-refactor methodology and its constraints (no bulk tests, public interface only)"
    - "Both ADRs follow MADR 4.0 org-mode format and have status: Accepted"
    - "ADR-0001 includes a Mermaid diagram showing Vitest's position in the toolchain"
    - "ADR-0002 includes a Mermaid flowchart of the red-green-refactor cycle"
    - "A contributor reading docs/decisions/ can understand every architectural choice made so far"
  artifacts:
    - path: "docs/decisions/0001-vitest.org"
      provides: "ADR for test framework selection: Vitest chosen, Jest/Mocha considered and rejected; includes toolchain diagram"
      contains: "Status: Accepted"
    - path: "docs/decisions/images/0001-vitest-toolchain.svg"
      provides: "Rendered SVG of the Vitest toolchain integration diagram (generated by ob-mermaid)"
    - path: "docs/decisions/0002-tdd.org"
      provides: "ADR for TDD methodology: red-green-refactor vertical slicing, public interfaces only, no bulk tests; includes cycle diagram"
      contains: "Status: Accepted"
    - path: "docs/decisions/images/0002-tdd-cycle.svg"
      provides: "Rendered SVG of the red-green-refactor cycle flowchart (generated by ob-mermaid)"
  key_links:
    - from: "docs/decisions/0001-vitest.org"
      to: "vitest.config.ts (Plan 02)"
      via: "ADR documents the decision already implemented in Plan 02"
      pattern: "Decision Outcome.*Vitest"
    - from: "docs/decisions/0002-tdd.org"
      to: "CONTRIBUTING.org (Plan 01)"
      via: "ADR provides architectural rationale for rules captured in CONTRIBUTING.org"
      pattern: "red-green-refactor"
---

<objective>
Write the two foundational ADRs that document the test framework and TDD methodology choices before any feature code is written. Each ADR includes a Mermaid diagram rendered via ob-mermaid.

Purpose: ADR-06 requires these ADRs to exist before Phase 1 execution. They provide the "why" behind the tooling decisions so that future contributors (and future phases) understand the constraints are intentional — not arbitrary. The diagrams make the decisions visually scannable.

Output:
- docs/decisions/0001-vitest.org — ADR for Vitest as test framework (status: Accepted) with toolchain graph LR diagram
- docs/decisions/images/0001-vitest-toolchain.svg — rendered SVG (generate with C-c C-c on the mermaid block)
- docs/decisions/0002-tdd.org — ADR for TDD red-green-refactor methodology (status: Accepted) with cycle flowchart
- docs/decisions/images/0002-tdd-cycle.svg — rendered SVG (generate with C-c C-c on the mermaid block)

Prerequisites: docs/decisions/ and docs/decisions/images/ must exist (created in Plan 01).
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@.planning/research/STACK.org
@.planning/phases/01-tooling-practice/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write ADR-0001 — Vitest as test framework</name>
  <files>docs/decisions/0001-vitest.org
docs/decisions/images/0001-vitest-toolchain.svg</files>
  <action>
Copy the structure from docs/decisions/0000-template.org and create
docs/decisions/0001-vitest.org.

This ADR documents the choice of Vitest as the test framework for BookTab.
Use the exact MADR 4.0 org-mode structure from the template. All content must
be accurate based on the project's actual constraints.

Required content:

- **Title**: Use Vitest as the test framework
- **Status**: Accepted
- **Context and Problem Statement**: BookTab is a TypeScript project built
  with Vite 7. We need a test framework for TDD red-green-refactor. The
  framework must support native ESM (no CommonJS transform required),
  TypeScript without additional configuration, and fast execution for a tight
  red-green loop.
- **Decision Drivers**:
  - Native ESM support (no jest.config transform setup)
  - Same configuration as Vite (no parallel config maintenance)
  - Fast execution for tight TDD feedback loop
  - TypeScript support without Babel/ts-jest
  - Actively maintained (2025/2026)
- **Considered Options**:
  - Vitest
  - Jest (with ts-jest or Babel transform)
  - Mocha + Chai
- **Decision Outcome**: Chosen: Vitest. Because it shares Vite's
  configuration, supports native ESM and TypeScript without extra transforms,
  and has a compatible API surface with Jest (easy for contributors familiar
  with Jest).
- **Positive Consequences**: No transform setup; same vitest.config.ts as
  vite.config.ts pattern; fast (~100ms startup); stable API.
- **Negative Consequences**: Vitest requires Vite in the toolchain (already
  a dependency for this project — not a new constraint).
- **Pros and Cons sections**: Fill in for all three options with honest
  trade-offs.

- **Diagram section**: Include a Mermaid diagram showing how Vitest integrates
  in the toolchain. Use this exact block (ob-mermaid syntax, :file required):

  #+begin_src mermaid :file ./images/0001-vitest-toolchain.svg :theme neutral
  graph LR
      TS["TypeScript source\n(src/**/*.ts)"]
      TESTS["Test files\n(tests/**/*.test.ts)"]
      VITE["vite.config.ts\n(Vite 7)"]
      VCFG["vitest.config.ts\n(extends Vite config)"]
      VITEST["Vitest runner\n(npm run test)"]
      OUT["Test results\npass / fail"]

      TS --> VCFG
      TESTS --> VCFG
      VITE --> VCFG
      VCFG --> VITEST
      VITEST --> OUT
  #+end_src
  #+RESULTS:
  [[file:./images/0001-vitest-toolchain.svg]]

After writing the org file, generate the SVG by running ob-mermaid on the
block (C-c C-c in Emacs, or use mmdc CLI:
  mmdc -i docs/decisions/0001-vitest.org is not the right approach —
instead open the file in Emacs and execute the block).

If running in a non-Emacs environment, create a placeholder SVG noting it
needs to be regenerated:
  echo '<svg xmlns="http://www.w3.org/2000/svg"><text y="20">Run ob-mermaid C-c C-c to generate</text></svg>' > docs/decisions/images/0001-vitest-toolchain.svg

The ADR must be factually accurate and represent the real rationale captured
in STACK.org research.
  </action>
  <verify>
    <automated>ls docs/decisions/0001-vitest.org docs/decisions/images/0001-vitest-toolchain.svg && grep "Status" docs/decisions/0001-vitest.org | grep -i "accepted" && grep -i "mermaid" docs/decisions/0001-vitest.org</automated>
  </verify>
  <done>0001-vitest.org exists; Status is Accepted; contains Decision Outcome section naming Vitest; Mermaid diagram block present; SVG file exists in images/; all MADR 4.0 sections present</done>
</task>

<task type="auto">
  <name>Task 2: Write ADR-0002 — TDD red-green-refactor methodology</name>
  <files>docs/decisions/0002-tdd.org
docs/decisions/images/0002-tdd-cycle.svg</files>
  <action>
Copy the structure from docs/decisions/0000-template.org and create
docs/decisions/0002-tdd.org.

This ADR documents the TDD red-green-refactor vertical slicing methodology
adopted for BookTab. It must explain the specific constraints locked in
STATE.org, not just generic TDD advocacy.

Required content:

- **Title**: Adopt TDD red-green-refactor vertical slicing for all features
- **Status**: Accepted
- **Context and Problem Statement**: BookTab needs a consistent testing
  approach. Without a documented methodology, tests tend to be written in bulk
  after implementation (reducing their value as design tools), or they test
  internal implementation details (making refactoring costly). We need a
  methodology that produces honest, maintainable tests.
- **Decision Drivers**:
  - Tests should drive design, not verify existing code
  - No tests written in bulk after implementation (DEV-03)
  - Tests must survive refactoring without rewrite (public interface only — DEV-04)
  - One cohesive behavior tested per cycle (vertical slice)
  - Each phase must begin with a cleanup pass (DEV-05)
- **Considered Options**:
  - Red-green-refactor vertical slicing (one test → one implementation → repeat)
  - Spec-first (write all tests, then all implementation)
  - Test-after (write implementation, then tests)
- **Decision Outcome**: Chosen: Red-green-refactor vertical slicing. Because
  it keeps test and implementation in sync, forces each test to be written when
  behavior is freshest in mind, and produces tests that are coupled to public
  behavior (not internal structure).
- **Specific constraints** (in Positive Consequences or sub-section):
  1. One test written → run (must fail, RED) → minimal implementation to pass
     (GREEN) → refactor if needed → repeat
  2. No writing multiple tests before any implementation
  3. Tests call only public exports — no importing private functions, no
     mocking internals
  4. Each phase begins with a tidy-up commit before any new feature work
- **Negative Consequences**: Slower initial velocity on simple features vs.
  write-all-tests-first. Accepted: design quality and refactor safety outweigh
  speed.

- **Diagram section**: Include a Mermaid flowchart of the red-green-refactor
  cycle. Use this exact block (ob-mermaid syntax, :file required):

  #+begin_src mermaid :file ./images/0002-tdd-cycle.svg :theme neutral
  flowchart LR
      A([Start:\nnew behaviour]) --> B
      B["Write one\nfailing test"] --> C
      C(["Run test\nsuite"])
      C --> D{Result?}
      D -- RED\nfail --> E["Write minimal\nimplementation"]
      E --> F(["Run test\nsuite"])
      F --> G{Result?}
      G -- RED\nstill failing --> E
      G -- GREEN\npassing --> H{"Refactor\nneeded?"}
      H -- Yes --> I["Refactor\n(keep tests green)"]
      I --> J(["Run test\nsuite"])
      J --> K{Result?}
      K -- GREEN --> L([Next\nbehaviour])
      K -- RED --> I
      H -- No --> L
  #+end_src
  #+RESULTS:
  [[file:./images/0002-tdd-cycle.svg]]

After writing the org file, generate the SVG by running ob-mermaid on the
block (C-c C-c in Emacs).

If running in a non-Emacs environment, create a placeholder SVG:
  echo '<svg xmlns="http://www.w3.org/2000/svg"><text y="20">Run ob-mermaid C-c C-c to generate</text></svg>' > docs/decisions/images/0002-tdd-cycle.svg

The ADR must be specific to BookTab's constraints, not a generic TDD explainer.
  </action>
  <verify>
    <automated>ls docs/decisions/0002-tdd.org docs/decisions/images/0002-tdd-cycle.svg && grep "Status" docs/decisions/0002-tdd.org | grep -i "accepted" && grep -i "red-green-refactor\|vertical" docs/decisions/0002-tdd.org && grep -i "mermaid" docs/decisions/0002-tdd.org</automated>
  </verify>
  <done>0002-tdd.org exists; Status is Accepted; contains specific constraints (public interface only, no bulk tests, tidy-up rule); Mermaid diagram block present; SVG file exists in images/; all MADR 4.0 sections present</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls docs/decisions/` shows: README.org, 0000-template.org, 0001-vitest.org, 0002-tdd.org, images/
2. `ls docs/decisions/images/` shows: .gitkeep, 0001-vitest-toolchain.svg, 0002-tdd-cycle.svg
3. Both ADRs have "Status" heading with "Accepted" value
4. `grep -n "Decision Outcome" docs/decisions/0001-vitest.org` — present
5. `grep -n "red-green-refactor\|vertical" docs/decisions/0002-tdd.org` — present
6. `grep -n "mermaid" docs/decisions/0001-vitest.org` — present
7. `grep -n "mermaid" docs/decisions/0002-tdd.org` — present
8. Both files are valid org-mode (no markdown syntax, #+title: header present)
</verification>

<success_criteria>
- ADR-0001 (Vitest) written and accepted — test framework choice documented with toolchain diagram (DEV-06 ✓)
- ADR-0002 (TDD) written and accepted — methodology and specific constraints documented with red-green-refactor cycle diagram (DEV-02, DEV-03, DEV-04, DEV-06 ✓)
- All ADRs follow MADR 4.0 org-mode format from the template
- Both ADRs include ob-mermaid diagram blocks with :file header arguments and placeholder or real SVGs committed
- A contributor reading docs/decisions/ understands the rationale for every architectural choice made so far (Phase 1 success criterion 3 ✓)
- Red-green-refactor workflow is documented with practice rules and visual diagram captured (Phase 1 success criterion 4 ✓)
</success_criteria>

<output>
After completion, create `.planning/phases/01-tooling-practice/01-03-SUMMARY.md` using the summary template.
</output>
