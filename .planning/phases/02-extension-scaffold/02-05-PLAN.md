---
phase: 02-extension-scaffold
plan: "05"
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - .storybook/main.ts
  - .storybook/preview.ts
  - src/newtab/App.stories.tsx
  - tests/e2e/newtab.spec.ts
  - playwright.config.ts
  - package.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "npm run storybook starts Storybook and displays at least one component story without error"
    - "Storybook is configured with Vite builder and React framework"
    - "App.stories.tsx shows loading, ready, and error states as separate stories"
    - "Playwright smoke test loads the built extension in Chromium and verifies the new tab page renders"
    - "npm run e2e runs the Playwright smoke test and passes"
  artifacts:
    - path: ".storybook/main.ts"
      provides: "Storybook configuration: Vite builder, React framework, story discovery pattern"
    - path: ".storybook/preview.ts"
      provides: "Storybook preview configuration: global decorators (QueryClientProvider, CSS)"
    - path: "src/newtab/App.stories.tsx"
      provides: "Stories for App component: Loading, Ready, Error states with appropriate mocks"
    - path: "tests/e2e/newtab.spec.ts"
      provides: "Playwright smoke test: load extension in Chromium, verify new tab renders BookTab"
    - path: "playwright.config.ts"
      provides: "Playwright config: Chromium only, tests/e2e/ directory"
  key_links:
    - from: ".storybook/main.ts"
      to: "src/newtab/App.stories.tsx"
      via: "Storybook discovers stories matching *.stories.tsx pattern"
    - from: "tests/e2e/newtab.spec.ts"
      to: "dist/"
      via: "Playwright loads the built extension from dist/ via launchPersistentContext"
    - from: "playwright.config.ts"
      to: "docs/decisions/0006-playwright-e2e.org"
      via: "Config implements the Chromium-only strategy from ADR-0006"
    - from: "src/newtab/App.stories.tsx"
      to: "docs/decisions/0005-storybook.org"
      via: "First story fulfills ADR-0005's purpose (component isolation)"
---

<objective>
Set up Storybook for component isolation and Playwright for E2E smoke tests.
Both require a working build (Plan 02-02) and a renderable component with
multiple states (Plan 02-04).

Purpose: Storybook allows developing and viewing components in isolation
across all their states (loading, ready, error) without running the full
extension. Playwright E2E tests verify the extension actually loads in a
browser and renders correctly. Together they complete the testing pyramid
for Phase 2.

Output:
- Storybook configured with Vite builder + React framework
- App.stories.tsx with loading/ready/error stories
- npm run storybook works
- Playwright smoke test for extension loading
- npm run e2e works
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@docs/decisions/0005-storybook.org
@docs/decisions/0006-playwright-e2e.org
@docs/decisions/0012-vitest-browser-mode.org
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Storybook</name>
  <files>.storybook/main.ts
.storybook/preview.ts
package.json</files>
  <action>
Initialize Storybook with Vite builder and React framework:

  npx storybook@latest init --builder vite --framework @storybook/react-vite --no-dev

This will:
- Create .storybook/ directory with main.ts and preview.ts
- Add storybook and @storybook/react-vite to devDependencies
- Add "storybook" and "build-storybook" scripts to package.json

After init:
1. Clean up any boilerplate stories added by the init command (remove
   src/stories/ directory if created)
2. Verify .storybook/main.ts uses Vite builder and React framework
3. Update .storybook/main.ts story discovery to match our file pattern:
   stories: ['../src/**/*.stories.@(ts|tsx)']
4. Update .storybook/preview.ts to import App.css for consistent styling
5. Add npm run storybook script if not already added:
   "storybook": "storybook dev -p 6006"
   "build-storybook": "storybook build"

Verify Storybook starts without errors (it will show no stories until Task 2).
  </action>
  <verify>
    <automated>ls .storybook/main.ts .storybook/preview.ts && grep "storybook" package.json</automated>
  </verify>
  <done>.storybook/ configured with Vite builder and React framework; npm run storybook script exists; boilerplate cleaned up</done>
</task>

<task type="auto">
  <name>Task 2: Write App component stories</name>
  <files>src/newtab/App.stories.tsx</files>
  <action>
Create src/newtab/App.stories.tsx with stories for each App state.

The App component renders based on XState machine state, which is bridged
from TanStack Query state. For Storybook, we need to render App in isolation
with mocked dependencies:

1. Story: "Loading" — App in loading state
   - Mock useBookTabData to return { isLoading: true, data: undefined }
   - Machine stays in 'loading' state

2. Story: "Ready" — App in ready state with empty library
   - Mock useBookTabData to return { isLoading: false, data: getDefaultData() }
   - Machine transitions to 'ready'

3. Story: "Error" — App in error state
   - Mock useBookTabData to return { isError: true, error: new Error('Storage failed') }
   - Machine transitions to 'error'

Each story needs:
- QueryClientProvider wrapper (via decorator)
- Appropriate mocks for the storage hooks

Use Storybook CSF 3 format (Component Story Format).
The stories should be viewable without any browser extension APIs.

After writing stories, verify:
- npm run storybook starts and shows all three stories
- Each story renders the expected UI for its state
  </action>
  <verify>
    <automated>ls src/newtab/App.stories.tsx</automated>
  </verify>
  <done>App.stories.tsx exists with Loading, Ready, and Error stories; all three render correctly in Storybook</done>
</task>

<task type="auto">
  <name>Task 3: Install Playwright and write E2E smoke test</name>
  <files>playwright.config.ts
tests/e2e/newtab.spec.ts
package.json</files>
  <action>
Install Playwright:
  npm install -D @playwright/test

Chromium should already be installed from the Vitest browser mode setup
(@vitest/browser-playwright). Verify with:
  npx playwright install chromium --dry-run

If not installed:
  npx playwright install chromium

Create playwright.config.ts:
- testDir: 'tests/e2e'
- Chromium only (no Firefox — per ADR-0006)
- No webServer config (we run build separately)

Create tests/e2e/newtab.spec.ts:
- Use chromium.launchPersistentContext() to load the extension:
  const context = await chromium.launchPersistentContext('', {
    headless: false,
    args: [
      `--disable-extensions-except=${path.resolve('dist')}`,
      `--load-extension=${path.resolve('dist')}`,
    ],
  });

- Wait for the extension's new tab page to appear
- Verify the page contains "BookTab" text
- Close the context

NOTE: This test requires `npm run build` to have run first (dist/ must exist).
The E2E script should handle this:
  "e2e": "npm run build && npx playwright test"

Add the e2e script to package.json.

Also add dist/ and test-results/ to .gitignore if not already there.

Verify:
- npm run e2e builds the extension and runs the smoke test
- The test passes (BookTab text found on the new tab page)
  </action>
  <verify>
    <automated>ls playwright.config.ts tests/e2e/newtab.spec.ts && grep "e2e" package.json</automated>
  </verify>
  <done>playwright.config.ts exists; newtab.spec.ts smoke test loads extension in Chromium and verifies BookTab renders; npm run e2e passes</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run storybook` starts without error and shows 3 App stories (Loading, Ready, Error)
2. `npm run e2e` builds the extension and the Playwright smoke test passes
3. `npm run test` still passes all existing unit tests
4. `npm run build` still succeeds
5. .storybook/ directory exists with main.ts and preview.ts
6. playwright.config.ts configures Chromium only
7. No boilerplate Storybook stories remain
</verification>

<success_criteria>
- Storybook runs and displays at least one component story (Success criterion 6 ✓)
- Playwright smoke test runs against the Chromium build and passes (Success criterion 7 ✓)
- Testing pyramid complete for Phase 2:
  - Unit tests (Vitest Node) for machine + schema + storage
  - Component stories (Storybook) for visual state verification
  - E2E smoke test (Playwright Chromium) for extension loading
- All npm scripts work: test, build, storybook, e2e
</success_criteria>

<output>
After completion, create `.planning/phases/02-extension-scaffold/02-05-SUMMARY.md` using the summary template.
</output>
