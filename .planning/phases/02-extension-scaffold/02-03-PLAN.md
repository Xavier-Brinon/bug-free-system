---
phase: 02-extension-scaffold
plan: "03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/schema.ts
  - src/storage.ts
  - tests/unit/schema.test.ts
  - tests/unit/storage.test.ts
  - src/newtab/main.tsx
autonomous: true
requirements:
  - CORE-03

must_haves:
  truths:
    - "src/schema.ts exports TypeScript types (BookTabData, BookRecord, UserSettings), Zod schemas, and getDefaultData()"
    - "getDefaultData() returns an object with schemaVersion: 1"
    - "Zod schemas validate data at runtime — used for import validation"
    - "src/storage.ts exports TanStack Query hooks wrapping browser.storage.local"
    - "QueryClientProvider is wired into main.tsx"
    - "All code written via TDD: one test → one implementation → repeat"
    - "Tests exercise public interfaces only — no internal mocking"
  artifacts:
    - path: "src/schema.ts"
      provides: "TypeScript types, Zod validation schemas, getDefaultData() with schemaVersion: 1, STORAGE_KEY constant"
    - path: "src/storage.ts"
      provides: "TanStack Query hooks: useBookTabData(), useAddBook(), useUpdateBook(), useDeleteBook(); createQueryClient() factory"
    - path: "tests/unit/schema.test.ts"
      provides: "Unit tests for schema validation, default data shape, type constraints"
    - path: "tests/unit/storage.test.ts"
      provides: "Unit tests for storage module public API"
  key_links:
    - from: "src/schema.ts"
      to: "src/storage.ts"
      via: "Storage module imports types, validation, and STORAGE_KEY from schema"
      pattern: "import { BookTabData, bookTabDataSchema, STORAGE_KEY } from './schema'"
    - from: "src/storage.ts"
      to: "src/newtab/App.tsx (Plan 02-04)"
      via: "App component will use storage hooks for data access"
    - from: "src/schema.ts"
      to: "docs/decisions/0008-storage-local.org"
      via: "Schema implements the data structure documented in ADR-0008"
    - from: "src/newtab/main.tsx"
      to: "src/storage.ts"
      via: "main.tsx wraps App in QueryClientProvider using createQueryClient()"
---

<objective>
Create the data schema and storage layer using TDD. Lock the data shape with
schemaVersion: 1. Wire TanStack Query into the React tree.

Purpose: The data schema is the foundation of the entire application. Locking
it now (with schemaVersion: 1) means every subsequent phase builds on a known,
validated data shape. TanStack Query wrapping browser.storage.local handles
the async race condition pitfall and provides consistent loading/error/success
states across all components.

Output:
- src/schema.ts with types, Zod schemas, getDefaultData(), STORAGE_KEY
- src/storage.ts with TanStack Query hooks
- Unit tests for both modules
- QueryClientProvider wired into main.tsx
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@.planning/research/ARCHITECTURE.org
@.planning/research/PITFALLS.org
@docs/decisions/0004-tanstack-query.org
@docs/decisions/0008-storage-local.org
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/schema.ts with TDD</name>
  <files>src/schema.ts
tests/unit/schema.test.ts</files>
  <action>
Write tests first, then implementation. Follow TDD red-green-refactor:

Test 1 (RED): getDefaultData() returns object with schemaVersion: 1
  → Implement getDefaultData() (GREEN)

Test 2 (RED): getDefaultData() returns empty books object
  → Extend getDefaultData() if needed (GREEN)

Test 3 (RED): getDefaultData() returns settings with defaultView: 'current'
  → Extend getDefaultData() if needed (GREEN)

Test 4 (RED): Zod schema validates a correct BookTabData object
  → Implement bookTabDataSchema (GREEN)

Test 5 (RED): Zod schema rejects object with missing schemaVersion
  → Verify schema catches this (GREEN)

Test 6 (RED): Zod schema rejects book with invalid status value
  → Verify schema catches this (GREEN)

Test 7 (RED): STORAGE_KEY constant equals 'booktab_data'
  → Export STORAGE_KEY (GREEN)

The schema should implement these types from ARCHITECTURE.org:

interface BookTabData {
  schemaVersion: number;
  books: Record<string, BookRecord>;
  settings: UserSettings;
}

interface BookRecord {
  id: string;
  title: string;
  authors: string[];
  coverUrl?: string;
  isbn?: string;
  externalId?: string;
  status: 'want_to_read' | 'reading' | 'read';
  addedAt: string;
  startedAt?: string;
  finishedAt?: string;
  tags: string[];
  priority: number;
  queueNote?: string;
  readingNotes?: string;
  review?: string;
}

interface UserSettings {
  defaultView: 'current' | 'queue' | 'history';
}

Use Zod schemas alongside TypeScript types for runtime validation. Export both
the types (for TypeScript) and the schemas (for import validation).
  </action>
  <verify>
    <automated>npm run test -- --project unit</automated>
  </verify>
  <done>src/schema.ts exports types, Zod schemas, getDefaultData(), STORAGE_KEY; all unit tests pass; getDefaultData().schemaVersion === 1</done>
</task>

<task type="auto">
  <name>Task 2: Create src/storage.ts with TDD</name>
  <files>src/storage.ts
tests/unit/storage.test.ts</files>
  <action>
Write tests first, then implementation. Follow TDD red-green-refactor.

The storage module wraps browser.storage.local with TanStack Query hooks.
All storage access in the app goes through this module — no other module
calls browser.storage.local directly.

Test 1 (RED): createQueryClient() returns a QueryClient instance
  → Implement createQueryClient() (GREEN)

Test 2 (RED): loadBookTabData() reads from browser.storage.local and returns
BookTabData (or default if empty)
  → Implement loadBookTabData() (GREEN)

Test 3 (RED): saveBookTabData() writes to browser.storage.local
  → Implement saveBookTabData() (GREEN)

For the TanStack Query hooks (useBookTabData, useAddBook, useUpdateBook,
useDeleteBook), these are React hooks that can only be tested in component
tests (Vitest browser mode). In this plan, export them from storage.ts but
defer their integration tests to Plan 02-04 when they are wired into the
React tree.

The storage module must:
- Import types and STORAGE_KEY from schema.ts
- Use webextension-polyfill: import browser from 'webextension-polyfill'
- Validate data read from storage using Zod schema
- Return getDefaultData() if storage is empty or validation fails
- Wrap all storage.set() calls in try/catch for quota errors

NOTE: For unit tests, browser.storage.local must be mocked since we are
running in Node (not a real extension context). Create a minimal mock of
the browser API for testing purposes. The mock should be in a test helper,
not in the production code.
  </action>
  <verify>
    <automated>npm run test -- --project unit</automated>
  </verify>
  <done>src/storage.ts exports createQueryClient(), loadBookTabData(), saveBookTabData(), and TanStack Query hooks; all unit tests pass; browser.storage.local is properly mocked in tests</done>
</task>

<task type="auto">
  <name>Task 3: Wire QueryClientProvider into main.tsx</name>
  <files>src/newtab/main.tsx</files>
  <action>
Update src/newtab/main.tsx to wrap <App /> in a QueryClientProvider:

import { QueryClientProvider } from '@tanstack/react-query';
import { createQueryClient } from '../storage';

const queryClient = createQueryClient();

ReactDOM.createRoot(document.getElementById('root')!).render(
  <QueryClientProvider client={queryClient}>
    <App />
  </QueryClientProvider>
);

This ensures all components in the tree can use TanStack Query hooks.
The XState machine integration happens in Plan 02-04.

After wiring, verify:
- npm run build still succeeds
- npm run test still passes
  </action>
  <verify>
    <automated>npm run build && npm run test</automated>
  </verify>
  <done>main.tsx wraps App in QueryClientProvider; npm run build succeeds; npm run test passes</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run test -- --project unit` passes all schema and storage tests
2. `npm run build` succeeds (no import errors, no type errors)
3. src/schema.ts exports getDefaultData() with schemaVersion: 1
4. src/storage.ts exports createQueryClient() and TanStack Query hooks
5. src/newtab/main.tsx wraps App in QueryClientProvider
6. All tests follow TDD: each test was written before its implementation
</verification>

<success_criteria>
- Data schema includes schemaVersion field from day one (CORE-03 ✓)
- Schema validated at runtime via Zod (import safety)
- Storage access centralized in one module (no scattered browser.storage.local calls)
- TanStack Query provides loading/error/success states for all data access
- QueryClientProvider wired into React tree
- All code written via TDD red-green-refactor
</success_criteria>

<output>
After completion, create `.planning/phases/02-extension-scaffold/02-03-SUMMARY.md` using the summary template.
</output>
