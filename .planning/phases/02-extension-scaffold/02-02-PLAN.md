---
phase: 02-extension-scaffold
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - manifest.json
  - vite.config.ts
  - src/newtab/index.html
  - src/newtab/main.tsx
  - src/newtab/App.tsx
  - src/newtab/App.css
  - package.json
autonomous: true
requirements:
  - CORE-01
  - CORE-02

must_haves:
  truths:
    - "manifest.json is valid MV3 with chrome_url_overrides.newtab pointing to src/newtab/index.html"
    - "npm run build produces a dist/ directory with bundled extension files"
    - "web-ext lint passes with zero errors and zero CSP warnings against the dist/ output"
    - "Extension loads in Firefox via about:debugging and replaces the new tab page"
    - "No inline JavaScript, no CDN scripts — everything bundled by Vite"
    - "No inline event handlers in HTML"
  artifacts:
    - path: "manifest.json"
      provides: "MV3 manifest declaring new tab override, storage + unlimitedStorage permissions, host permissions for Open Library"
    - path: "vite.config.ts"
      provides: "Vite build config using vite-plugin-web-extension to read manifest.json; merges with vitest.config.ts test settings"
    - path: "src/newtab/index.html"
      provides: "HTML shell loaded as new tab page — minimal, CSP-safe, contains root div and module script"
    - path: "src/newtab/main.tsx"
      provides: "React entry point: creates root and renders <App /> into the root div"
    - path: "src/newtab/App.tsx"
      provides: "Minimal App component — placeholder text, no state yet (state added in Plan 02-04)"
    - path: "src/newtab/App.css"
      provides: "Basic CSS for the new tab page"
  key_links:
    - from: "manifest.json"
      to: "vite.config.ts"
      via: "vite-plugin-web-extension reads manifest.json as its entry config"
      pattern: "webExtension({ manifest })"
    - from: "manifest.json"
      to: "src/newtab/index.html"
      via: "chrome_url_overrides.newtab points to the HTML entry"
      pattern: "chrome_url_overrides"
    - from: "src/newtab/index.html"
      to: "src/newtab/main.tsx"
      via: "script type=module src pointing to main.tsx"
    - from: "src/newtab/main.tsx"
      to: "src/newtab/App.tsx"
      via: "imports and renders <App />"
---

<objective>
Create the Firefox extension shell — manifest, Vite build pipeline, and minimal
React app — so the extension loads as the new tab page.

Purpose: This is the first time BookTab becomes a real extension. The manifest
tells Firefox to load our React SPA as the new tab page. Vite bundles
everything via vite-plugin-web-extension. The output is a dist/ directory that
can be loaded in Firefox via about:debugging. No state management yet — just
the shell.

Output:
- manifest.json (MV3, new tab override, storage + host permissions)
- Vite config with vite-plugin-web-extension
- src/newtab/index.html + main.tsx + App.tsx + App.css
- npm run build produces dist/
- web-ext lint passes
- Extension loads in Firefox and shows the placeholder React app
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@.planning/research/STACK.org
@.planning/research/ARCHITECTURE.org
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest.json</name>
  <files>manifest.json</files>
  <action>
Create manifest.json at the project root with MV3 format:

{
  "manifest_version": 3,
  "name": "BookTab",
  "version": "0.1.0",
  "description": "Your reading life, one new tab at a time",
  "chrome_url_overrides": {
    "newtab": "src/newtab/index.html"
  },
  "permissions": [
    "storage",
    "unlimitedStorage"
  ],
  "host_permissions": [
    "https://openlibrary.org/*",
    "https://covers.openlibrary.org/*"
  ],
  "browser_specific_settings": {
    "gecko": {
      "id": "booktab@yourdomain.com",
      "strict_min_version": "109.0"
    }
  }
}

Key decisions:
- chrome_url_overrides.newtab points to the HTML file that Vite will process
- storage + unlimitedStorage permissions for browser.storage.local
- host_permissions for Open Library API and cover images (both domains needed)
- gecko.id prevents random ID assignment on reinstall (preserves storage in dev)
- strict_min_version 109.0 = when Firefox MV3 became GA
  </action>
  <verify>
    <automated>cat manifest.json | grep -E "manifest_version|chrome_url_overrides|storage|openlibrary|gecko"</automated>
  </verify>
  <done>manifest.json exists with MV3 format, new tab override, storage permissions, host permissions, gecko settings</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vite with vite-plugin-web-extension</name>
  <files>vite.config.ts</files>
  <action>
The project already has a vitest.config.ts for test configuration. Create a
separate vite.config.ts for the build pipeline, or merge them if Vitest can
extend the Vite config.

The recommended approach: keep vitest.config.ts for test-specific settings
(projects, browser mode) and create vite.config.ts for the build pipeline.
Vitest automatically reads vite.config.ts as its base config.

Create vite.config.ts:

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import webExtension from 'vite-plugin-web-extension';

export default defineConfig({
  plugins: [
    react(),
    webExtension({
      manifest: 'manifest.json',
    }),
  ],
  build: {
    outDir: 'dist',
  },
});

NOTE: @vitejs/plugin-react may need to be installed as a devDependency:
  npm install -D @vitejs/plugin-react

Update vitest.config.ts to not conflict with the Vite build config. The test
config should import from vitest/config (not vite) and only contain test-specific
settings — Vitest will merge with vite.config.ts automatically.
  </action>
  <verify>
    <automated>cat vite.config.ts | grep -E "webExtension|react|manifest"</automated>
  </verify>
  <done>vite.config.ts exists with vite-plugin-web-extension and react plugin; build output targets dist/</done>
</task>

<task type="auto">
  <name>Task 3: Create src/newtab/ with HTML, React entry, and App component</name>
  <files>src/newtab/index.html
src/newtab/main.tsx
src/newtab/App.tsx
src/newtab/App.css</files>
  <action>
Create the src/newtab/ directory and its files.

src/newtab/index.html:
- DOCTYPE html
- charset utf-8, viewport meta
- Title: "BookTab — New Tab"
- <div id="root"></div>
- <script type="module" src="./main.tsx"></script>
- NO inline JavaScript, NO inline event handlers, NO CDN scripts

src/newtab/main.tsx:
- Import React, ReactDOM from 'react-dom/client'
- Import App from './App'
- Import './App.css'
- ReactDOM.createRoot(document.getElementById('root')!).render(<App />)
- NOTE: Do NOT add QueryClientProvider or XState here yet — those are added
  in Plans 02-03 and 02-04 respectively.

src/newtab/App.tsx:
- Minimal functional component
- Returns a simple placeholder:
  <div className="app">
    <h1>BookTab</h1>
    <p>Your reading tracker</p>
  </div>
- No state, no hooks — state management added in Plan 02-04

src/newtab/App.css:
- Basic styling: centered content, clean font, neutral background
- Keep it minimal — this is a scaffold, not the final design
  </action>
  <verify>
    <automated>ls src/newtab/index.html src/newtab/main.tsx src/newtab/App.tsx src/newtab/App.css</automated>
  </verify>
  <done>All four files exist in src/newtab/; index.html has no inline JS; main.tsx renders App into root div; App.tsx is a minimal placeholder component</done>
</task>

<task type="auto">
  <name>Task 4: Add build scripts and verify</name>
  <files>package.json</files>
  <action>
Add the following scripts to package.json:
  "build": "vite build",
  "dev": "vite",
  "lint:ext": "web-ext lint --source-dir dist"

Run the full verification:
1. npm run build — must exit 0 and produce a dist/ directory
2. web-ext lint --source-dir dist — must pass with zero errors/warnings
3. npm run test — must still pass (empty suite)
4. Verify dist/ contains the bundled extension files

If web-ext lint requires adjustments to manifest or build output, fix them
before declaring the task done.

NOTE on Firefox testing: Loading the extension in Firefox requires manual
steps via about:debugging that cannot be automated in this plan. The automated
verification is: build succeeds + lint passes. Manual Firefox load is a
human verification step.
  </action>
  <verify>
    <automated>npm run build && web-ext lint --source-dir dist && npm run test</automated>
  </verify>
  <done>npm run build produces dist/; web-ext lint passes with zero errors; npm run test still passes; extension is ready for manual Firefox testing</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` exits 0
2. `ls dist/` shows bundled extension files
3. `web-ext lint --source-dir dist` reports zero errors and zero CSP warnings
4. `npm run test` still passes
5. manifest.json has manifest_version: 3, chrome_url_overrides.newtab, storage permission
6. src/newtab/index.html has no inline JS or inline event handlers
7. Extension can be manually loaded in Firefox via about:debugging (human step)
</verification>

<success_criteria>
- Extension replaces Firefox new tab via chrome_url_overrides.newtab (CORE-01 ✓)
- All scripts CSP-safe: no inline JS, no CDN scripts, all bundled by Vite (CORE-02 ✓)
- npm run build produces a working dist/ directory
- web-ext lint passes with zero warnings
- Minimal React app renders in the new tab page
</success_criteria>

<output>
After completion, create `.planning/phases/02-extension-scaffold/02-02-SUMMARY.md` using the summary template.
</output>
