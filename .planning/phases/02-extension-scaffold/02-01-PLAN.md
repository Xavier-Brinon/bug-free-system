---
phase: 02-extension-scaffold
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/decisions/0006-playwright-e2e.org
  - docs/decisions/0007-xstate.org
  - docs/decisions/0008-storage-local.org
  - docs/decisions/images/0006-playwright-e2e.svg
  - docs/decisions/images/0007-xstate-app-machine.svg
  - docs/decisions/images/0008-storage-data-flow.svg
  - docs/decisions/README.org
autonomous: true
requirements:
  - ADR-02
  - ADR-03
  - DEV-05

must_haves:
  truths:
    - "Phase starts with a tidy-up commit (DEV-05) before any new work"
    - "ADR-0006 documents Playwright/Chromium E2E strategy before any E2E code"
    - "ADR-0007 documents XState v5 state management before any machine code"
    - "ADR-0008 documents browser.storage.local as sole persistence before storage layer code"
    - "All three ADRs follow MADR 4.0 org-mode format with Mermaid diagrams"
  artifacts:
    - path: "docs/decisions/0006-playwright-e2e.org"
      provides: "Decision record for Playwright/Chromium E2E testing strategy"
    - path: "docs/decisions/0007-xstate.org"
      provides: "Decision record for XState v5 as the state management solution"
    - path: "docs/decisions/0008-storage-local.org"
      provides: "Decision record for browser.storage.local as sole persistence layer"
  key_links:
    - from: "docs/decisions/0007-xstate.org"
      to: "src/machines/appMachine.ts (Plan 02-04)"
      via: "ADR documents the machine pattern before implementation"
    - from: "docs/decisions/0008-storage-local.org"
      to: "src/storage.ts (Plan 02-03)"
      via: "ADR documents storage architecture before implementation"
    - from: "docs/decisions/0006-playwright-e2e.org"
      to: "Playwright smoke test (Plan 02-05)"
      via: "ADR documents E2E strategy before scaffold"
---

<objective>
Start Phase 2 with a mandatory tidy-up commit, then write three reserved ADRs
(0006, 0007, 0008) before any implementation code.

Purpose: CONTRIBUTING.org Rule 1 requires every phase to begin with a tidy-up
step. Rule 2 requires ADRs before implementation. Phase 2 introduces Playwright
E2E, XState state management, and browser.storage.local persistence — all three
need their ADRs written before any code touches these concerns.

Output:
- Tidy-up commit (may be trivial since Phase 1 was config/docs only)
- ADR-0006: Playwright/Chromium E2E strategy
- ADR-0007: XState v5 for all stateful logic
- ADR-0008: browser.storage.local as sole persistence
- docs/decisions/README.org updated with new ADR entries
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@.planning/research/STACK.org
@.planning/research/ARCHITECTURE.org
@.planning/research/PITFALLS.org
@CONTRIBUTING.org
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tidy-up commit (DEV-05)</name>
  <files></files>
  <action>
Review the codebase for dead imports, unused variables, inconsistent naming,
lint warnings, or type errors. Run:
  npx tsc --noEmit   (expect no source files yet — should pass trivially)
  npm run test        (should pass on empty suite)

Phase 1 produced only configuration and documentation files, so this tidy-up
is expected to be trivial. If anything is found, fix and commit. If nothing
needs fixing, document that the tidy-up was performed and found nothing.

This step must happen BEFORE any new Phase 2 work.
  </action>
  <verify>
    <automated>npm run test</automated>
  </verify>
  <done>Tidy-up step completed; codebase is clean; npm run test passes</done>
</task>

<task type="auto">
  <name>Task 2: Write ADR-0006 (Playwright/Chromium E2E strategy)</name>
  <files>docs/decisions/0006-playwright-e2e.org
docs/decisions/images/0006-playwright-e2e.svg</files>
  <action>
Write ADR-0006 documenting the Playwright/Chromium E2E testing strategy.

Key content:
- Context: Playwright's Firefox build does NOT support loading browser extensions.
  Extension E2E tests must run in Chromium via launchPersistentContext().
- Decision: E2E smoke tests run in Playwright + Chromium as a proxy for Firefox.
  Manual Firefox acceptance testing is required for true validation.
- Testing split (three tiers):
  1. Vitest (Node) — unit tests: XState machines, schema, storage, utilities
  2. Vitest browser mode (Chromium) — component tests: React components in
     real browser via vitest-browser-react (ADR-0012)
  3. Playwright (Chromium) — E2E smoke tests: full extension loaded, new tab
     page renders, basic user flows work end-to-end
  4. Manual Firefox — true acceptance testing via about:debugging
- The Chromium E2E tests require a Vite build (`npm run build`) before
  Playwright can load the extension from dist/.
- Include a Mermaid diagram showing the test pyramid / testing tiers.

Follow MADR 4.0 org-mode format. Copy structure from docs/decisions/0000-template.org.
  </action>
  <verify>
    <automated>ls docs/decisions/0006-playwright-e2e.org && grep -l "Accepted" docs/decisions/0006-playwright-e2e.org && grep -l "mermaid" docs/decisions/0006-playwright-e2e.org</automated>
  </verify>
  <done>ADR-0006 exists, has Accepted status, follows MADR 4.0 format, includes Mermaid diagram for test tiers</done>
</task>

<task type="auto">
  <name>Task 3: Write ADR-0007 (XState v5 state management)</name>
  <files>docs/decisions/0007-xstate.org
docs/decisions/images/0007-xstate-app-machine.svg</files>
  <action>
Write ADR-0007 documenting XState v5 as the state management solution.

Key content:
- Context: BookTab has async data loading, view routing (3-4 views), and form
  state. Without explicit state management, these concerns produce ad-hoc
  boolean flags (isLoading, hasError, isReady) that are easy to get wrong.
- Decision: All stateful logic flows through XState v5 machines/actors. No
  ad-hoc useState flags for async transitions.
- The app machine pattern: loading → ready → error states.
  - loading: initial state, entered on app mount, waits for storage data
  - ready: data loaded, UI interactive, user can navigate views
  - error: storage read failed, shows error with retry option
- @xstate/react bridges machines to React: useMachine(), useSelector(),
  useActorRef(). Components are pure renderers of machine state.
- Alternatives considered: useState/useReducer (ad-hoc, no state diagram),
  Zustand (global store, not machine-based), Redux (heavyweight for this scope).
- Include a Mermaid state diagram showing the app machine.

Follow MADR 4.0 org-mode format.
  </action>
  <verify>
    <automated>ls docs/decisions/0007-xstate.org && grep -l "Accepted" docs/decisions/0007-xstate.org && grep -l "mermaid" docs/decisions/0007-xstate.org</automated>
  </verify>
  <done>ADR-0007 exists, has Accepted status, follows MADR 4.0 format, includes Mermaid state diagram for app machine</done>
</task>

<task type="auto">
  <name>Task 4: Write ADR-0008 (browser.storage.local as sole persistence)</name>
  <files>docs/decisions/0008-storage-local.org
docs/decisions/images/0008-storage-data-flow.svg</files>
  <action>
Write ADR-0008 documenting browser.storage.local as the sole persistence layer.

Key content:
- Context: BookTab needs persistent storage that survives browser restarts and
  privacy wipes. The extension is local-only with no backend.
- Decision: All data stored in browser.storage.local under a single root key
  ('booktab_data'). Never use window.localStorage (wiped on privacy clear).
- Single root key pattern: booktab_data → { schemaVersion, books, settings }
  - Pros: atomic reads/writes, easy export/import, easy schema migration
  - Cons: full re-serialization on every change (fine for <500 books)
- Versioned schema: schemaVersion: 1 from day one. Migration layer before any
  schema change ships. Import validation via Zod.
- TanStack Query wrapper: all storage access goes through TanStack Query hooks.
  Loading/error/success states handled by the query layer. Cache invalidated
  via browser.storage.onChanged listener.
- storage.ts is the only module that calls browser.storage.local — no scattered
  storage calls from UI code.
- Pitfalls pre-empted: async race on tab open (TanStack Query loading state),
  localStorage wipe (using storage.local instead), quota errors (try/catch on
  set(), store covers as URLs not base64).
- Include a Mermaid diagram showing the data flow: React → TanStack Query →
  storage.ts → browser.storage.local.

Follow MADR 4.0 org-mode format.
  </action>
  <verify>
    <automated>ls docs/decisions/0008-storage-local.org && grep -l "Accepted" docs/decisions/0008-storage-local.org && grep -l "mermaid" docs/decisions/0008-storage-local.org</automated>
  </verify>
  <done>ADR-0008 exists, has Accepted status, follows MADR 4.0 format, includes Mermaid data flow diagram</done>
</task>

<task type="auto">
  <name>Task 5: Update ADR tracking</name>
  <files>docs/decisions/README.org</files>
  <action>
Update the "Current ADRs" table in docs/decisions/README.org to include:
- 0006: Playwright/Chromium for E2E smoke tests — Accepted
- 0007: XState v5 for all stateful logic — Accepted
- 0008: browser.storage.local as sole persistence — Accepted

Also update .planning/STATE.org ADR log to mark 0006, 0007, 0008 as Written.
  </action>
  <verify>
    <automated>grep "0006" docs/decisions/README.org && grep "0007" docs/decisions/README.org && grep "0008" docs/decisions/README.org</automated>
  </verify>
  <done>README.org and STATE.org ADR tables updated with ADRs 0006, 0007, 0008</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `ls docs/decisions/0006-playwright-e2e.org docs/decisions/0007-xstate.org docs/decisions/0008-storage-local.org` — all exist
2. All three ADRs have `Accepted` status
3. All three ADRs contain `#+begin_src mermaid :file` blocks
4. `npm run test` still passes
5. docs/decisions/README.org table includes 0006, 0007, 0008
</verification>

<success_criteria>
- Tidy-up commit performed before any new work (DEV-05 ✓)
- ADR-0006 documents Playwright/Chromium E2E strategy (ADR-02 ✓)
- ADR-0007 documents XState v5 state management (ADR-02 ✓)
- ADR-0008 documents browser.storage.local persistence (ADR-02 ✓)
- All ADRs written before their respective implementations (ADR-03 ✓)
- ADR tracking tables updated in README.org and STATE.org
</success_criteria>

<output>
After completion, create `.planning/phases/02-extension-scaffold/02-01-SUMMARY.md` using the summary template.
</output>
