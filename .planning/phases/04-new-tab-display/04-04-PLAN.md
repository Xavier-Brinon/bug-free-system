---
phase: 04-new-tab-display
plan: "04"
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - src/components/CurrentlyReading.stories.tsx
  - src/components/EmptyHero.stories.tsx
  - src/components/QueueCount.stories.tsx
  - src/newtab/App.stories.tsx
  - tests/e2e/newtab.spec.ts
autonomous: true
requirements:
  - DISP-01
  - DISP-02
  - DISP-03

must_haves:
  truths:
    - "CurrentlyReading stories cover: with cover image, without cover image"
    - "EmptyHero stories cover: default empty state with CTA"
    - "QueueCount stories cover: zero books, one book, many books"
    - "App stories updated to cover: dashboard with currently-reading book, dashboard with empty hero, dashboard with queue count"
    - "Playwright E2E test verifies: add a book, set it to Reading, verify hero display, set it to Read, verify empty state"
    - "Playwright E2E test verifies: queue count updates when books are added/removed with want_to_read status"
    - "All existing E2E tests continue to pass"
    - "Storybook builds and all story tests pass"
  artifacts:
    - path: "src/components/CurrentlyReading.stories.tsx"
      provides: "Storybook stories for CurrentlyReading: with cover, without cover"
    - path: "src/components/EmptyHero.stories.tsx"
      provides: "Storybook stories for EmptyHero: default state"
    - path: "src/components/QueueCount.stories.tsx"
      provides: "Storybook stories for QueueCount: zero, one, many"
    - path: "src/newtab/App.stories.tsx"
      provides: "Updated App stories: DashboardReading, DashboardEmpty, DashboardWithQueue"
    - path: "tests/e2e/newtab.spec.ts"
      provides: "E2E tests for hero display, empty state, and queue count"
  key_links:
    - from: "src/newtab/App.stories.tsx"
      to: "src/newtab/App.tsx"
      via: "Stories render App in various dashboard states"
    - from: "tests/e2e/newtab.spec.ts"
      to: "src/newtab/App.tsx"
      via: "E2E tests exercise the full dashboard through the real extension"
---

<objective>
Add Storybook stories for all new Phase 4 components and update App stories
to cover dashboard states. Add Playwright E2E tests verifying the hero
display, empty state, and queue count in the real extension.

Purpose: Stories provide visual documentation and regression testing for the
new display components. E2E tests verify the full stack works end-to-end:
status changes update the hero, the empty state appears/disappears correctly,
and the queue count reflects the actual data.

Output:
- Storybook stories for CurrentlyReading, EmptyHero, QueueCount
- Updated App stories for dashboard states
- Playwright E2E tests for display requirements
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@src/components/CurrentlyReading.tsx
@src/components/EmptyHero.tsx
@src/components/QueueCount.tsx
@src/newtab/App.tsx
@src/newtab/App.stories.tsx
@src/components/BookCard.stories.tsx
@src/components/BookForm.stories.tsx
@src/components/BookList.stories.tsx
@tests/e2e/newtab.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Storybook stories for new components</name>
  <files>src/components/CurrentlyReading.stories.tsx
src/components/EmptyHero.stories.tsx
src/components/QueueCount.stories.tsx</files>
  <action>
Create Storybook stories for each new component. Follow existing story
patterns from BookCard.stories.tsx and BookForm.stories.tsx.

CurrentlyReading.stories.tsx:
- WithCover: book has a coverUrl — shows image alongside title/author
- WithoutCover: book has no coverUrl — shows title/author without image
- Use a sample BookRecord with status "reading" and realistic data

EmptyHero.stories.tsx:
- Default: renders the empty state prompt with CTA button
- Use action() for the onStartAdding callback

QueueCount.stories.tsx:
- ZeroBooks: count = 0
- OneBook: count = 1
- ManyBooks: count = 12

All stories should use the Meta/StoryObj pattern from @storybook/react.
Verify all stories render without errors.
  </action>
  <verify>
    <automated>npm run test -- --project storybook</automated>
  </verify>
  <done>All component stories render without errors; storybook tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update App stories for dashboard states</name>
  <files>src/newtab/App.stories.tsx</files>
  <action>
Update App.stories.tsx to cover the new dashboard states. Existing stories
(Loading, ErrorState) remain. Update or add:

1. DashboardEmpty: ready.viewing with no books — shows EmptyHero + QueueCount(0)
2. DashboardReading: ready.viewing with one book set to "reading" — shows
   CurrentlyReading hero + QueueCount
3. DashboardWithQueue: ready.viewing with multiple books in different statuses
   — shows CurrentlyReading hero + QueueCount showing want_to_read count

For each story, use setQueryData to pre-seed the TanStack Query cache
with appropriate BookTabData (following the pattern from the existing stories).

Verify all stories render the correct layout (hero vs empty, correct count).
  </action>
  <verify>
    <automated>npm run test -- --project storybook</automated>
  </verify>
  <done>App stories cover dashboard states; all storybook tests pass; stories show correct hero/empty/count states</done>
</task>

<task type="auto">
  <name>Task 3: Playwright E2E tests for display requirements</name>
  <files>tests/e2e/newtab.spec.ts</files>
  <action>
Add E2E tests that verify the display requirements in the real extension.
Keep existing E2E tests. Add new test cases:

Test 1: Hero display — add a book → set status to "reading" → verify the
book title appears in the hero section (not just in the list)

Test 2: Empty state — with no books, verify the empty state prompt is
visible. Add a book set to "reading", verify hero appears. Change status
away from "reading", verify empty state returns.

Test 3: Queue count — add two books (both default to "want_to_read") →
verify queue count shows "2 books to read". Set one to "reading" → verify
count updates to "1 book to read".

These tests exercise the full stack through the real extension, ensuring
the display updates correctly as the underlying data changes.

NOTE: Build the extension first (`npm run build`). Use the existing
Playwright launch setup (launchPersistentContext with the built extension).
  </action>
  <verify>
    <automated>npm run e2e</automated>
  </verify>
  <done>E2E tests pass: hero display, empty state, and queue count all verified end-to-end; existing E2E tests still pass</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint && npm run fmt:check` pass
2. `npm run test` passes all tests (unit + browser + storybook)
3. `npm run e2e` passes all E2E tests
4. `npm run build` succeeds
5. Storybook shows all new component stories and updated App stories
6. E2E tests verify hero display, empty state, and queue count
7. All Phase 4 display requirements met end-to-end
</verification>

<success_criteria>
- All new components have Storybook stories
- App stories cover all dashboard states (reading, empty, queue)
- E2E tests verify DISP-01 (hero), DISP-02 (empty state), DISP-03 (queue count)
- All existing tests and E2E continue to pass
- Phase 4 is complete: every new tab surfaces the reading dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/04-new-tab-display/04-04-SUMMARY.md` using the summary template.
</output>
