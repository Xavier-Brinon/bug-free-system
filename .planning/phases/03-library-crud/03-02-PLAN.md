---
phase: 03-library-crud
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/BookForm.tsx
  - tests/browser/BookForm.test.tsx
  - src/newtab/App.stories.tsx
autonomous: true
requirements:
  - LIB-01
  - LIB-03

must_haves:
  truths:
    - "BookForm component accepts onSubmit callback and optional initial book data"
    - "Form has fields for title (required), author (required), and cover URL (optional)"
    - "Submit is disabled when required fields are empty"
    - "onSubmit receives a well-formed object with title, authors array, and optional coverUrl"
    - "When initialBook is provided, form is pre-filled for editing (LIB-03)"
    - "When initialBook is absent, form is empty for adding (LIB-01)"
    - "Form can be cancelled/dismissed via onCancel callback"
    - "All code written via TDD: tests first, implementation second"
    - "Tests use Vitest browser mode (vitest-browser-react) — real DOM rendering"
  artifacts:
    - path: "src/components/BookForm.tsx"
      provides: "Controlled form component for adding and editing books"
    - path: "tests/browser/BookForm.test.tsx"
      provides: "Browser-mode component tests for BookForm behaviour"
  key_links:
    - from: "src/components/BookForm.tsx"
      to: "src/newtab/App.tsx (Plan 03-04)"
      via: "App renders BookForm and connects onSubmit to library machine"
    - from: "src/components/BookForm.tsx"
      to: "src/schema.ts"
      via: "Form output matches createBookRecord() input shape"
---

<objective>
Create the BookForm component that handles both adding new books and editing
existing ones. The component is a controlled form with validation.

Purpose: LIB-01 requires manual book entry (title, author, optional cover URL)
and LIB-03 requires editing existing book details. A single form component
handles both cases — empty for add, pre-filled for edit. The form is tested
in browser mode with real DOM interactions.

Output:
- src/components/BookForm.tsx (controlled form, add + edit modes)
- tests/browser/BookForm.test.tsx (browser-mode component tests)
</objective>

<execution_context>
@/Users/xavierbrinon/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/xavierbrinon/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.org
@.planning/STATE.org
@src/schema.ts
@src/newtab/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BookForm component with TDD (browser tests)</name>
  <files>src/components/BookForm.tsx
tests/browser/BookForm.test.tsx</files>
  <action>
Write tests first, then implementation. Follow TDD red-green-refactor.
Tests run in Vitest browser mode using vitest-browser-react's render().

The BookForm component:
- Props: { onSubmit: (data: BookFormData) => void; onCancel: () => void;
  initialBook?: BookRecord }
- BookFormData: { title: string; authors: string[]; coverUrl?: string }
- Controlled inputs for title, author(s), coverUrl
- Author input is a single text field (comma-separated, split on submit)
- Submit button disabled when title or author is empty

Test 1 (RED): BookForm renders title, author, and cover URL inputs
  → Create component with three inputs (GREEN)

Test 2 (RED): Submit button is disabled when title is empty
  → Add disabled logic based on title value (GREEN)

Test 3 (RED): Submit button is disabled when author is empty
  → Extend disabled logic to check author (GREEN)

Test 4 (RED): Submitting the form calls onSubmit with { title, authors, coverUrl }
  → Wire up form submission (GREEN)

Test 5 (RED): Author string "Frank Herbert, Brian Herbert" produces
authors: ["Frank Herbert", "Brian Herbert"]
  → Split and trim author string on submit (GREEN)

Test 6 (RED): When initialBook is provided, inputs are pre-filled
  → Initialize state from initialBook prop (GREEN)

Test 7 (RED): Cancel button calls onCancel
  → Add cancel button wired to onCancel (GREEN)

Test 8 (RED): coverUrl is optional — form submits without it
  → Verify submission works with empty coverUrl (GREEN)

Use vitest-browser-react's render() and page/userEvent for interactions.
Component should be self-contained (no global state, no machine dependency).
All state management is via controlled React state (useState).
  </action>
  <verify>
    <automated>npm run test -- --project browser</automated>
  </verify>
  <done>BookForm renders with title/author/coverUrl fields; submit disabled when required fields empty; onSubmit called with correct data; initialBook pre-fills form; cancel works; all browser tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run test -- --project browser` passes all BookForm tests
2. `npm run test` passes all tests (unit + browser + storybook)
3. `npm run build` succeeds
4. BookForm handles both add (empty) and edit (pre-filled) modes
5. Required field validation prevents empty submissions
</verification>

<success_criteria>
- BookForm supports adding books manually with title + author (LIB-01 ✓)
- BookForm supports editing existing book details via initialBook (LIB-03 ✓)
- Form is a reusable, isolated component with no global dependencies
- All code written via TDD with browser-mode tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-library-crud/03-02-SUMMARY.md` using the summary template.
</output>
