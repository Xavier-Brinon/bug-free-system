#+title: Stack Research: BookTab
#+author: BookTab
#+date: [2026-02-25 Tue]
#+startup: indent
#+options: toc:3 num:t ^:{}

- *Domain* :: Firefox browser extension -- new tab page replacement, local-only
  book tracker
- *Researched* :: [2026-02-25 Tue]
- *Revised* :: [2026-02-26 Thu] -- UI layer upgraded to React 19; TanStack
  Query added; Storybook and Playwright added (see ADR-0003, ADR-0004,
  ADR-0005, ADR-0006)
- *Confidence* :: HIGH (all core decisions verified against official Mozilla
  docs and npm registry)

* Recommended Stack

#+begin_src mermaid :file ./images/stack-toolchain-layers.svg :theme neutral
graph LR
    subgraph BuildTime["Build-time (devDependencies)"]
        TS["TypeScript 5.9.3\n(type checking)"]
        VITE["Vite 7.3.1\n(bundler)"]
        PLUGIN["vite-plugin-web-extension 4.5.0\n(extension-aware build)"]
        VITEST["Vitest\n(unit/component tests)"]
        RTL["@testing-library/react\n(component tests)"]
        SB["Storybook\n(component isolation)"]
        PW["Playwright / Chromium\n(E2E smoke tests)"]
        WEBEXT["web-ext 9.3.0\n(lint / package / sign)"]
        TYPES["@types/webextension-polyfill\n(browser.* types)"]
        TS --> VITE
        PLUGIN --> VITE
        TYPES --> TS
        RTL --> VITEST
    end

    subgraph Runtime["Runtime (dependencies)"]
        POLYFILL["webextension-polyfill 0.12.0\n(Promise-based browser.*)"]
        REACT["React 19\n(UI rendering layer)"]
        XSTATE["XState v5 + @xstate/react\n(state machines)"]
        TQ["TanStack Query\n(async storage layer)"]
        ZOD["zod 3.x\n(schema validation)"]
    end

    VITE -- bundles --> Runtime
    VITEST -- tests --> Runtime
    SB -- renders --> REACT
    PW -- smoke tests --> VITE
    WEBEXT -- lints/packages --> VITE
#+end_src
#+RESULTS:
[[file:./images/stack-toolchain-layers.svg]]

** Core technologies

#+CAPTION: Core technology stack
| Technology                     | Version | Purpose                  | Why Recommended                                                     |
|--------------------------------+---------+--------------------------+---------------------------------------------------------------------|
| Manifest V3                    | 3       | Extension manifest format | GA in Firefox since v109; forward standard; Firefox MV3 keeps event pages not service workers |
| TypeScript                     | 5.9.3   | Type-safe JavaScript     | ~@types/webextension-polyfill~ gives typed ~browser.*~ APIs        |
| Vite                           | 7.3.1   | Build tool               | Multi-entry bundling, fast HMR, ESM output; handles extension pages naturally |
| =vite-plugin-web-extension=    | 4.5.0   | Extension-aware Vite plugin | Reads =manifest.json= as build config; auto-discovers entrypoints; wraps =web-ext= |
| =webextension-polyfill=        | 0.12.0  | Promise-based ~browser.*~ API | Cross-browser safety; use ~browser.*~ everywhere, never ~chrome.*~ |

** Browser APIs (no external libraries)

#+CAPTION: Browser APIs used
| API                              | Purpose                   | Notes                                                      |
|----------------------------------+---------------------------+------------------------------------------------------------|
| ~browser.storage.local~          | Persist all book data     | IndexedDB-backed; survives privacy wipes; never use =window.localStorage= |
| =chrome_url_overrides.newtab=    | Replace new tab page      | Confirmed MV2+MV3; HTML file must be bundled (no remote URLs) |
| Fetch API                        | Book metadata lookups     | Requires =host_permissions= in manifest for external domains |

** UI layer

*Decision: React 19 as the UI rendering layer (supersedes "Vanilla TS" recommendation)*

The original research recommended vanilla TypeScript with Preact as an upgrade
path. During Phase 1 planning, the scope of the UI was evaluated more
carefully: 4--6 distinct views (new tab hero, library list, book detail, queue,
search, import/export), stateful forms, conditional rendering driven by XState
machines, and async data from ~browser.storage.local~. This complexity
justified a proper component model.

React 19 was chosen over Preact because:
- ~@xstate/react~ (~useMachine~, ~useSelector~) is the official XState React
  binding -- Preact compatibility is unofficial and lags
- TanStack Query has first-class React support; Preact adapter is
  community-maintained
- Storybook supports React as a first-class framework; Preact requires manual
  configuration
- React 19's bundle cost (~45 KB) is acceptable at extension load time given
  the functionality gained

See ADR-0003 for full decision record.

#+CAPTION: UI layer
| Library                  | Version | Purpose                        | Notes                                        |
|--------------------------+---------+--------------------------------+----------------------------------------------|
| React                    | 19      | UI rendering layer             | Component model; hooks; concurrent features  |
| =react-dom=              | 19      | DOM renderer                   | Required alongside React                     |
| =@xstate/react=          | 5.x     | XState ↔ React bridge          | ~useMachine~, ~useSelector~ hooks            |
| TanStack Query           | 5.x     | Async storage access layer     | Loading/error/success states; cache; optimistic updates |

** Supporting libraries

#+CAPTION: Supporting libraries
| Library                      | Version | Purpose                   | When to Use                                      |
|------------------------------+---------+---------------------------+--------------------------------------------------|
| =@types/webextension-polyfill= | 0.12.5  | TypeScript types for ~browser.*~ | Always -- gives typed ~browser.storage.local~ |
| =web-ext=                    | 9.3.0   | CLI: run, lint, build, sign | Dev workflow; install separately for ~web-ext lint~ |
| =zod=                        | 3.x     | Runtime schema validation | Validate imported JSON at the import boundary    |
| Vitest                       | latest  | Test framework -- unit + component | TDD; native ESM; same config as Vite; jsdom environment |
| =@testing-library/react=     | latest  | Component behaviour tests  | Renders React components in jsdom; queries by role/label |
| =@testing-library/user-event= | latest | User interaction simulation | Types, clicks, form submission in tests          |
| =@testing-library/jest-dom=  | latest  | Custom DOM matchers        | ~toBeInTheDocument()~, ~toHaveValue()~, etc.     |
| XState                       | 5.x     | State machines / actors    | All stateful logic; async flows; UI transitions  |

** Development and testing tools

#+CAPTION: Development and testing tools
| Tool                     | Purpose                          | Notes                                                        |
|--------------------------+----------------------------------+--------------------------------------------------------------|
| =web-ext= CLI            | Live reload, lint, package       | ~web-ext run~ auto-reloads; ~web-ext lint~ catches manifest errors |
| Storybook                | Component isolation + docs       | Vite builder; React framework; visual regression via snapshots; setup in Phase 2 |
| Playwright / Chromium    | E2E integration smoke tests      | Extensions only work in Chromium via ~launchPersistentContext~; NOT Firefox (Playwright limitation); introduced in Phase 2 |
| Firefox DevTools         | Debug extension pages            | =about:debugging= → This Firefox → Inspect extension pages  |
| =addons-linter=          | Validate before submission       | Bundled inside ~web-ext lint~; catches policy violations     |
| TypeScript strict        | Catch bugs early                 | Set ="strict": true= in =tsconfig.json=                      |

*** Playwright + Firefox constraint (hard blocker -- document in ADR-0006)

Playwright's Firefox build does *not* support loading browser extensions.
Extension testing in Playwright only works with Chromium via
~chromium.launchPersistentContext()~ + ~--load-extension=dist/~ +
~--disable-extensions-except=dist/~.

This means BookTab integration tests run in a Chromium proxy, not real Firefox.
The split is:
- *Vitest + jsdom* :: unit logic, XState machines, storage module, schema
  validation
- *@testing-library/react* :: React component behaviour (within Vitest)
- *Playwright / Chromium* :: full extension load + UI smoke tests
- *web-ext lint* :: CSP / manifest policy validation
- *Manual Firefox* :: true extension acceptance (developer install)

The Chromium build requires ~vite build~ output before Playwright can load it,
so Playwright setup and the Vite build pipeline are introduced together in
Phase 2. See ADR-0006.

* Installation

#+name: install-commands
#+begin_src bash
# Core project setup
npm create vite@latest booktab -- --template react-ts

# Install Vite extension plugin and browser API polyfill
npm install webextension-polyfill
npm install -D vite-plugin-web-extension

# TypeScript types for browser APIs
npm install -D @types/webextension-polyfill

# Runtime validation (for JSON import)
npm install zod

# State machines + React bridge
npm install xstate @xstate/react

# Async storage layer
npm install @tanstack/react-query

# Test framework (jsdom environment for React)
npm install -D vitest @vitest/ui jsdom

# React Testing Library
npm install -D @testing-library/react @testing-library/user-event @testing-library/jest-dom

# Dev/build/lint/sign CLI
npm install -D web-ext

# TypeScript (usually included by Vite template, verify version)
npm install -D typescript@^5.9.0

# Playwright (Phase 2 -- install when build pipeline is ready)
# npm install -D @playwright/test
# npx playwright install chromium
#+end_src

* Manifest V3 template

#+name: manifest-template
#+begin_src json
{
  "manifest_version": 3,
  "name": "BookTab",
  "version": "1.0.0",
  "chrome_url_overrides": {
    "newtab": "src/newtab/index.html"
  },
  "permissions": [
    "storage",
    "unlimitedStorage"
  ],
  "host_permissions": [
    "https://openlibrary.org/*",
    "https://covers.openlibrary.org/*"
  ],
  "browser_specific_settings": {
    "gecko": {
      "id": "booktab@yourdomain.com",
      "strict_min_version": "109.0"
    }
  }
}
#+end_src

Notes:
- =browser_specific_settings.gecko.id= is required for ~web-ext sign~ and
  persistent storage in development profiles
- =strict_min_version: "109.0"= = when Firefox MV3 became GA (Feb 2023)
- No =background= needed -- all logic runs in the new tab page itself

* Alternatives considered

#+CAPTION: Alternatives considered and rejected
| Recommended                    | Alternative                  | When to Use Alternative                          |
|--------------------------------+------------------------------+--------------------------------------------------|
| MV3                            | MV2                          | Only if supporting Firefox < 109 (rare, outdated) |
| React 19                       | Vanilla TypeScript           | If UI were a single static view with no forms    |
| React 19                       | Preact                       | If @xstate/react and TanStack Query had first-class Preact support |
| React 19                       | Vue 3                        | If team preference strongly favoured Vue          |
| TanStack Query                 | SWR                          | SWR has less complete browser-storage adapter ecosystem |
| =vite-plugin-web-extension=    | Webpack + web-ext-webpack    | If team is Webpack-only; Vite is faster          |
| ~browser.storage.local~        | IndexedDB directly           | Only if storage.local API capabilities exceeded  |
| =zod=                          | =ajv=                        | If JSON Schema validation needed over TypeScript-first |

* What NOT to use

#+CAPTION: Technologies to avoid
| Avoid                   | Why                                                              | Use Instead              |
|-------------------------+------------------------------------------------------------------+--------------------------|
| =window.localStorage=   | Firefox clears it on privacy wipes even in extension contexts   | ~browser.storage.local~  |
| ~chrome.*~ namespace    | Callbacks-based; inconsistent with Firefox's Promise-based API  | ~browser.*~ via polyfill |
| Preact                  | ~@xstate/react~ and TanStack Query lack first-class Preact support | React 19               |
| Remote scripts / CDN    | Blocked by MV3 CSP; AMO flags them                              | Bundle everything via Vite |
| =eval()= / dynamic code | Banned in MV3 CSP; =addons-linter= rejects the extension        | Static imports only      |
| Service workers         | Chrome MV3 approach; Firefox MV3 uses event pages               | Event page or no background |
| ~node:sqlite~           | Node.js C++ binding; cannot run in browser extension context    | ~browser.storage.local~ JSON |
| Playwright + Firefox    | Playwright cannot load extensions in Firefox build              | Playwright + Chromium for extension E2E |

* Firefox-specific nuances

1. *MV3 vs Chrome MV3 are different.* Firefox MV3 keeps event pages (not
   service workers), keeps ~browser.*~ promises natively, and has more relaxed
   CSP than Chrome. Do not follow Chrome extension tutorials verbatim.

2. *~browser.*~ is native in Firefox.* The polyfill adds cross-browser safety
   but Firefox already exposes the full Promise-based API.

3. *Extension ID matters.* Without =browser_specific_settings.gecko.id=,
   Firefox assigns a random ID each reinstall -- this resets storage in
   development.

4. *New tab override requires user confirmation.* When installed from AMO,
   Firefox may prompt the user to confirm the new tab override. Expected
   behavior -- not a bug.

5. *=storage.local= is IndexedDB-backed.* Data survives browser restarts and
   privacy wipes (unlike =window.localStorage= in extension contexts).

* Version compatibility

#+CAPTION: Package version compatibility matrix
| Package                        | Version | Compatible With  | Notes                              |
|--------------------------------+---------+------------------+------------------------------------|
| =vite-plugin-web-extension=    | 4.5.0   | =vite@^4\|^5\|^6\|^7= | Supports Vite 4--7               |
| =webextension-polyfill=        | 0.12.0  | Firefox 109+     | Current as of Feb 2026             |
| =@types/webextension-polyfill= | 0.12.5  | TypeScript 5.2+  | DefinitelyTyped, maintained        |
| =web-ext=                      | 9.3.0   | Node ≥18         | Current LTS (Node 20/22)           |
| =vite=                         | 7.3.1   | Node ≥20.19      | Vite 7 requires newer Node         |
| =typescript=                   | 5.9.3   | Node ≥14.17      | Latest stable                      |
| React                          | 19      | Node ≥18         | React 19 stable (Dec 2024)         |
| =@xstate/react=                | 5.x     | React 18+        | Hooks-based; useMachine, useSelector |
| TanStack Query                 | 5.x     | React 18+        | React Query v5; stable             |

* Sources

- [[https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/chrome_url_overrides][MDN: chrome_url_overrides]] (Jul 17, 2025) -- MV2+MV3 support confirmed
- [[https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version][MDN: manifest_version]] (Jul 17, 2025) -- MV3 current standard
- [[https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/local][MDN: storage.local]] (Aug 1, 2025) -- IndexedDB-backed; localStorage warning
- [[https://extensionworkshop.com/documentation/develop/manifest-v3-migration-guide/][Firefox Extension Workshop: MV3 Migration Guide]] -- MV3 GA in Firefox 109
- [[https://playwright.dev/docs/chrome-extensions][Playwright: Chrome extensions]] -- confirms Chromium-only, Firefox not supported
- [[https://xstate.js.org/docs/][XState v5 docs]] -- @xstate/react hooks API
- [[https://tanstack.com/query/latest][TanStack Query v5 docs]] -- React-first async state management
- npm registry (Feb 2026) -- all package versions verified current

---
/Stack research for: Firefox new tab extension book tracker (BookTab)/
/Researched: [2026-02-25 Tue]/
/Revised: [2026-02-26 Thu] -- React 19 + TanStack Query + Storybook + Playwright confirmed/
