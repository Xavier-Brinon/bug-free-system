#+title: State: BookTab
#+author: BookTab
#+date: [2026-02-25 Tue]
#+startup: indent
#+options: toc:2 num:nil ^:{}

* Project Reference

- *Core Value* :: Every new tab is a reminder of what you're reading and
  what's next — keeping your reading life visible without leaving the browser.
- *Current Focus* :: Phase 7 -- Design System Polish (complete)
- *Stack* :: TypeScript 5.9.3 + Vite 7.3.1 + =vite-plugin-web-extension= +
  React 19 + ~@xstate/react~ + XState v5 + TanStack Query +
  ~browser.storage.local~ + Vitest browser mode (Playwright/Chromium) +
  =vitest-browser-react= + Storybook + Playwright/Chromium +
  Oxlint + Oxfmt
- *Target* :: React SPA delivered as a Firefox extension (Manifest V3) — the
  extension is a thin shell; the app is a standard React SPA in the new tab page
- *ADRs* :: =docs/decisions/= (MADR 4.0 structure, org-mode format)

See: [[file:PROJECT.org][PROJECT.org]] (updated [2026-02-26 Thu])

* Current Position

#+CAPTION: Current position
| Field            | Value                              |
|------------------+------------------------------------|
| Current Phase    | Phase 7: Design System Polish      |
| Current Plan     | Wave 4 (complete)                  |
| Phase Status     | Complete (4 waves)                 |
| Overall Progress | 7/7 phases complete                |

#+BEGIN_EXAMPLE
Progress: [████████████████████] 100%
Phase 1 [████] → Phase 2 [████] → Phase 3 [████] → Phase 4 [████] → Phase 5 [████] → Phase 6 [████] → Phase 7 [████]
#+END_EXAMPLE

* Phase Summary

#+CAPTION: Phase summary
| Phase | Name                        | Requirements            | Status      |
|-------+-----------------------------+-------------------------+-------------|
|     1 | Tooling & Practice          | ADR-01--03, DEV-01--06  | Complete    |
|     2 | Extension Scaffold          | CORE-01--04             | Complete    |
|     3 | Library CRUD                | LIB-01--04              | Complete    |
|     4 | New Tab Display             | DISP-01--03             | Complete    |
|     5 | Queue                       | QUEUE-01--02            | Complete    |
|     6 | Data Safety                 | DATA-01--03             | Complete    |
|     7 | Design System Polish        | (polish pass)           | Complete    |

* Performance Metrics

#+CAPTION: Project metrics
| Metric           | Value  |
|------------------+--------|
| Phases complete  | 7 / 7  |
| Requirements met | 25 / 25 |
| Plans executed   | 23     |
| ADRs written     | 13     |
| Tests passing    | 162    |

* Accumulated Context

** Architectural decisions (pre-ADR)

- *Storage* :: ~browser.storage.local~ only -- never =window.localStorage=
  (wiped on privacy clear)
- *Manifest* :: V3 (Firefox 109+) -- no service workers; event pages are fine
- *UI layer* :: React 19 -- chosen over Vanilla TS because UI complexity spans
  4--6 views, stateful forms, and XState/TanStack Query integration; ADR-0003
  written in Phase 1 before scaffold begins
- *Async storage* :: TanStack Query wraps ~browser.storage.local~ -- provides
  loading/error/success states and cache invalidation via
  ~browser.storage.onChanged~; ADR-0004 written in Phase 1
- *State management* :: XState v5 machines/actors for ALL stateful logic;
  ~@xstate/react~ (~useMachine~, ~useSelector~) bridges to React; ADR-0007
  written in Phase 2 before any machine code
- *No background script* :: architecture is single privileged page (new tab)
  with direct storage access
- *Book metadata API* :: Open Library only -- no API key = no key exposure in
  extension source; ADR-0009 written in Phase 3 before search is implemented
- *Data structure* :: =booktab_data= key →
  ~{ schemaVersion, books: Record<id, BookRecord>, settings }~
- *Component isolation* :: Storybook (Vite builder, React framework) --
  ADR-0005 written in Phase 1; installation in Phase 2 when first component exists
- *E2E testing* :: Playwright / Chromium only -- Playwright cannot load
  extensions in its Firefox build; ADR-0006 written in Phase 2 before E2E scaffold
- *Documentation* :: All docs in org-mode; ADRs follow MADR 4.0 structure in
  =docs/decisions/= as =.org= files

** Critical pitfalls (pre-empt in Phase 2)

1. *CSP blocks inline JS / CDN scripts* -- all handlers via
   ~addEventListener()~, all JS in =.js= files
2. =window.localStorage= *wiped on privacy clear* -- use
   ~browser.storage.local~ exclusively
3. *Async race on new tab open* -- show loading state until
   ~storage.get()~ resolves; TanStack Query handles loading/error/success
   states; gate writes behind =storageReady=
4. *Flat unversioned export schema* -- =schemaVersion: 1= in schema from
   day one; migration layer before any schema change ships
5. *Open Library rate limits* -- 400--600ms debounce, =User-Agent= header,
   both =openlibrary.org= + =covers.openlibrary.org= in =host_permissions=
6. *Destructive import without warning* -- auto-backup before import;
   confirmation dialog; schema validation before write
7. *Playwright + Firefox* -- Playwright cannot load extensions in its Firefox
   build; E2E smoke tests run in Chromium proxy via
   ~chromium.launchPersistentContext()~; manual Firefox acceptance testing
   required
8. *webextension-polyfill crashes in Storybook / non-extension contexts* --
   =webextension-polyfill= detects it is not running inside a browser
   extension and throws at import time ("This script should only be loaded
   in a browser extension"). Storybook renders stories in regular Chromium
   pages, not extension contexts. Fix: alias =webextension-polyfill= to a
   no-op mock via Vite =resolve.alias= in both =.storybook/main.ts=
   (~viteFinal~) and the Storybook project in =vitest.config.ts=. The mock
   lives at =.storybook/webextension-polyfill-mock.ts=. Stories override
   ~queryFn~ in decorators so the mock is never actually called.

** File format conventions

All project documentation is written in org-mode format (=.org= files).

*Exception -- GSD workflow artefacts:* The =.planning/phases/= directory
contains files ending in =-PLAN.md= and =-SUMMARY.md=. These use the ~.md~
extension because the GSD tooling (=gsd-tools.cjs=) hardcodes
~endsWith('-PLAN.md')~ and ~endsWith('-SUMMARY.md')~ when scanning for plans
and summaries. Renaming them to =.org= would break plan discovery, wave
execution, and progress tracking.

These files are GSD tooling artefacts, not project documentation. Their
content uses YAML frontmatter + XML task blocks (the GSD format). Do not
convert them to org-mode.

All other files -- =REQUIREMENTS.org=, =ROADMAP.org=, =STATE.org=,
=PROJECT.org=, =docs/decisions/*.org=, =CONTRIBUTING.org= -- are org-mode.

** Developer practice rules (locked in Phase 1)

- Every phase begins with a tidy-up step (refactoring/cleanup before new
  feature code)
- *ADR before implementation, at any phase* -- an ADR is written immediately
  before implementing any architecturally significant decision, at whatever
  phase that decision arises. If a decision is later revised, a new ADR
  is written that supersedes the previous one (old ADR status set to
  "Superseded by NNNN"). The history is never rewritten -- only extended.
  This creates a complete, honest decision log for learning purposes.
- TDD: red-green-refactor vertical slicing -- one test → one implementation
  → repeat
- No tests written in bulk after implementation
- Tests exercise public interfaces only -- no internal mocking, no
  implementation detail testing
- All ADRs include Mermaid diagrams (ob-mermaid syntax, =:file= header
  required) when the decision involves a flow, state transition, dependency
  graph, or data structure
- Branch per wave: work on =phase-NN/wave-W/short-description= branches,
  merge to =main= (=--no-ff=) when each wave is complete; next wave
  branches from the updated =main=

** ADR log (running -- updated as decisions are made)

| ADR    | Decision                           | Phase written | Status  |
|--------+------------------------------------+---------------+---------|
| 0001   | Vitest as test framework (jsdom)   | 1             | Superseded by 0012 |
| 0002   | TDD red-green-refactor methodology | 1             | Written |
| 0003   | React 19 as UI rendering layer     | 1             | Written |
| 0004   | TanStack Query for async storage   | 1             | Written |
| 0005   | Storybook for component isolation  | 1             | Written |
| 0006   | Playwright / Chromium for E2E      | 2             | Written |
| 0007   | XState v5 state management         | 2             | Written |
| 0008   | browser.storage.local only         | 2             | Written |
| 0009   | Open Library API                   | 3             | Pending |
| 0010   | Versioned JSON export schema       | 6             | Written |
| 0011   | Oxc (Oxlint + Oxfmt) for linting   | 2             | Written |
| 0012   | Vitest browser mode (supersedes 0001) | 1          | Written |
| 0013   | CSS custom properties as design tokens | 7         | Written |
| 0014   | System-preference dark mode          | 7             | Written |

** Open questions

- [ ] Does =unlimitedStorage= permission trigger a user-facing warning in
  Firefox? Evaluate in Phase 6 before AMO submission.
- [ ] What are Open Library's actual rate limit enforcement behaviours for a
  single-user extension? Test live in Phase 3.

** Todos

- [X] Initialize =docs/decisions/= with MADR 4.0 template (org-mode) -- Phase 1 (Plan 01-01)
- [X] Write CONTRIBUTING.org with locked practice rules -- Phase 1 (Plan 01-01)
- [X] Install Vitest + React + TanStack + testing-library -- Phase 1 (Plan 01-02)
- [X] Configure jsdom environment in vitest.config.ts -- Phase 1 (Plan 01-02)
- [X] Write ADR-0001 (Vitest) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0002 (TDD) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0003 (React 19) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0004 (TanStack Query) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0005 (Storybook) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0006 (Playwright / Chromium) -- Phase 2, before E2E scaffold
- [X] Write ADR-0007 (XState v5) -- Phase 2, before machine code
- [X] Write ADR-0008 (browser.storage.local) -- Phase 2, before storage layer
- [X] Write ADR-0011 (Oxc: Oxlint + Oxfmt) -- Phase 2, before any code
- [ ] Write ADR-0009 (Open Library API) -- Phase 3, before search feature
- [X] Write ADR-0010 (Versioned JSON export schema) -- Phase 6, before export feature
- [X] Scaffold extension with =vite-plugin-web-extension= -- Phase 2 (Plan 02-02)
- [X] Lock data schema in =schema.ts= before any feature code -- Phase 2 (Plan 02-03)
- [X] Install Oxlint + Oxfmt for code quality -- Phase 2 (Plan 02-01)
- [X] Create XState app machine (loading/ready/error) -- Phase 2 (Plan 02-04)
- [X] Set up Storybook with App stories -- Phase 2 (Plan 02-05)
- [X] Set up Playwright E2E smoke test -- Phase 2 (Plan 02-05)

** Blockers

None.

* Session Continuity

- *Last action* :: [2026-02-27 Thu] -- Phase 7 complete: Design system polish
  pass across 4 waves. ADR-0013 (CSS custom properties as design tokens) and
  ADR-0014 (system-preference dark mode). Three-layer token system (primitives,
  semantic, component). All hardcoded CSS values migrated to =var()= references.
  Global interactive states: =:focus-visible= with outline offset, =:active=
  scale feedback, consistent transitions on all interactive elements. Dark mode
  via =@media (prefers-color-scheme: dark)= overriding semantic tokens.
  162 tests passing (67 unit + 65 browser + 30 storybook + 11 E2E).
- *Next action* :: All phases complete. Project is feature-complete with polish.
- *Context for next session* :: All 7 phases complete on =main=. 25/25 v1
  requirements met plus design system polish. The app supports: CRUD operations
  on books, currently-reading hero display, queue view with intention notes,
  data export/import with auto-backup, design token system, interactive states,
  and system-preference dark mode. All tests passing, build clean, lint clean.

---
/STATE initialized: [2026-02-25 Tue]/
/Updated: [2026-02-27 Thu] -- Phase 7 complete: Design system polish. 7/7 phases, 13 ADRs, 162 tests passing/
