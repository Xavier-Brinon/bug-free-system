#+title: State: BookTab
#+author: BookTab
#+date: [2026-02-25 Tue]
#+startup: indent
#+options: toc:2 num:nil ^:{}

* Project Reference

- *Core Value* :: Every new tab is a reminder of what you're reading and
  what's next — keeping your reading life visible without leaving the browser.
- *Current Focus* :: Phase 1 -- Tooling & Practice Foundation
- *Stack* :: TypeScript 5.9.3 + Vite 7.3.1 + =vite-plugin-web-extension= +
  React 19 + ~@xstate/react~ + XState v5 + TanStack Query +
  ~browser.storage.local~ + Vitest (jsdom) + =@testing-library/react= +
  Storybook + Playwright/Chromium
- *Target* :: Firefox extension (Manifest V3)
- *ADRs* :: =docs/decisions/= (MADR 4.0 structure, org-mode format)

See: [[file:PROJECT.org][PROJECT.org]] (updated [2026-02-26 Thu])

* Current Position

#+CAPTION: Current position
| Field            | Value                              |
|------------------+------------------------------------|
| Current Phase    | Phase 1: Tooling & Practice        |
| Current Plan     | None (not started)                 |
| Phase Status     | Not started                        |
| Overall Progress | 0/6 phases complete                |

#+BEGIN_EXAMPLE
Progress: [░░░░░░░░░░░░░░░░░░░░] 0%
Phase 1 [░░░░] → Phase 2 [░░░░] → Phase 3 [░░░░] → Phase 4 [░░░░] → Phase 5 [░░░░] → Phase 6 [░░░░]
#+END_EXAMPLE

* Phase Summary

#+CAPTION: Phase summary
| Phase | Name                        | Requirements            | Status      |
|-------+-----------------------------+-------------------------+-------------|
|     1 | Tooling & Practice          | ADR-01--03, DEV-01--06  | Not started |
|     2 | Extension Scaffold          | CORE-01--04             | Not started |
|     3 | Library CRUD                | LIB-01--04              | Not started |
|     4 | New Tab Display             | DISP-01--03             | Not started |
|     5 | Queue                       | QUEUE-01--02            | Not started |
|     6 | Data Safety                 | DATA-01--03             | Not started |

* Performance Metrics

#+CAPTION: Project metrics
| Metric           | Value  |
|------------------+--------|
| Phases complete  | 0 / 6  |
| Requirements met | 0 / 25 |
| Plans executed   | 0      |
| ADRs written     | 0      |
| Tests passing    | 0      |

* Accumulated Context

** Architectural decisions (pre-ADR)

- *Storage* :: ~browser.storage.local~ only -- never =window.localStorage=
  (wiped on privacy clear)
- *Manifest* :: V3 (Firefox 109+) -- no service workers; event pages are fine
- *UI layer* :: React 19 -- chosen over Vanilla TS because UI complexity spans
  4--6 views, stateful forms, and XState/TanStack Query integration; see
  ADR-0003 (to be written in Phase 1)
- *Async storage* :: TanStack Query wraps ~browser.storage.local~ -- provides
  loading/error/success states and cache invalidation via
  ~browser.storage.onChanged~; see ADR-0004 (to be written in Phase 1)
- *State management* :: XState v5 machines/actors for ALL stateful logic;
  ~@xstate/react~ (~useMachine~, ~useSelector~) bridges to React; see ADR-0007
  (to be written in Phase 2)
- *No background script* :: architecture is single privileged page (new tab)
  with direct storage access
- *Book metadata API* :: Open Library only -- no API key = no key exposure in
  extension source; see ADR-0009 (to be written in Phase 2)
- *Data structure* :: =booktab_data= key →
  ~{ schemaVersion, books: Record<id, BookRecord>, settings }~
- *Component isolation* :: Storybook (Vite builder, React framework) --
  installation deferred to Phase 2 (no components exist in Phase 1);
  ADR-0005 written in Phase 1; see ADR-0005
- *E2E testing* :: Playwright / Chromium only -- Playwright cannot load
  extensions in its Firefox build; see ADR-0006 (to be written in Phase 2)
- *Documentation* :: All docs in org-mode; ADRs follow MADR 4.0 structure in
  =docs/decisions/= as =.org= files

** Critical pitfalls (pre-empt in Phase 2)

1. *CSP blocks inline JS / CDN scripts* -- all handlers via
   ~addEventListener()~, all JS in =.js= files
2. =window.localStorage= *wiped on privacy clear* -- use
   ~browser.storage.local~ exclusively
3. *Async race on new tab open* -- show loading state until
   ~storage.get()~ resolves; TanStack Query handles loading/error/success
   states; gate writes behind =storageReady=
4. *Flat unversioned export schema* -- =schemaVersion: 1= in schema from
   day one; migration layer before any schema change ships
5. *Open Library rate limits* -- 400--600ms debounce, =User-Agent= header,
   both =openlibrary.org= + =covers.openlibrary.org= in =host_permissions=
6. *Destructive import without warning* -- auto-backup before import;
   confirmation dialog; schema validation before write
7. *Playwright + Firefox* -- Playwright cannot load extensions in its Firefox
   build; E2E smoke tests run in Chromium proxy via
   ~chromium.launchPersistentContext()~; manual Firefox acceptance testing
   required

** File format conventions

All project documentation is written in org-mode format (=.org= files).

*Exception -- GSD workflow artefacts:* The =.planning/phases/= directory
contains files ending in =-PLAN.md= and =-SUMMARY.md=. These use the ~.md~
extension because the GSD tooling (=gsd-tools.cjs=) hardcodes
~endsWith('-PLAN.md')~ and ~endsWith('-SUMMARY.md')~ when scanning for plans
and summaries. Renaming them to =.org= would break plan discovery, wave
execution, and progress tracking.

These files are GSD tooling artefacts, not project documentation. Their
content uses YAML frontmatter + XML task blocks (the GSD format). Do not
convert them to org-mode.

All other files -- =REQUIREMENTS.org=, =ROADMAP.org=, =STATE.org=,
=PROJECT.org=, =docs/decisions/*.org=, =CONTRIBUTING.org= -- are org-mode.

** Developer practice rules (locked in Phase 1)

- Every phase begins with a tidy-up step (refactoring/cleanup before new
  feature code)
- Every phase plan includes at least one ADR task (written before
  implementation)
- TDD: red-green-refactor vertical slicing -- one test → one implementation
  → repeat
- No tests written in bulk after implementation
- Tests exercise public interfaces only -- no internal mocking, no
  implementation detail testing
- All ADRs include Mermaid diagrams (ob-mermaid syntax, =:file= header
  required) when the decision involves a flow, state transition, dependency
  graph, or data structure

** ADR numbering (locked)

| ADR    | Decision                           | Phase |
|--------+------------------------------------+-------|
| 0001   | Vitest as test framework           |     1 |
| 0002   | TDD red-green-refactor methodology |     1 |
| 0003   | React 19 as UI rendering layer     |     1 |
| 0004   | TanStack Query for async storage   |     1 |
| 0005   | Storybook for component isolation  |     1 |
| 0006   | Playwright / Chromium for E2E      |     2 |
| 0007   | XState v5 state management         |     2 |
| 0008   | browser.storage.local only         |     2 |
| 0009   | Open Library API                   |     2 |
| 0010   | Versioned JSON export schema       |     6 |

** Open questions

- [ ] Does =unlimitedStorage= permission trigger a user-facing warning in
  Firefox? Evaluate in Phase 6 before AMO submission.
- [ ] What are Open Library's actual rate limit enforcement behaviours for a
  single-user extension? Test live in Phase 3.

** Todos

- [ ] Initialize =docs/decisions/= with MADR 4.0 template (org-mode) -- Phase 1 (Plan 01-01)
- [ ] Write CONTRIBUTING.org with locked practice rules -- Phase 1 (Plan 01-01)
- [ ] Install Vitest + React + TanStack + testing-library -- Phase 1 (Plan 01-02)
- [ ] Configure jsdom environment in vitest.config.ts -- Phase 1 (Plan 01-02)
- [ ] Write ADR-0001 (Vitest) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0002 (TDD) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0003 (React 19) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0004 (TanStack Query) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0005 (Storybook) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0006 (Playwright) -- Phase 2
- [ ] Write ADR-0007 (XState v5) -- Phase 2
- [ ] Scaffold extension with =vite-plugin-web-extension= -- Phase 2
- [ ] Lock data schema in =schema.ts= before any feature code -- Phase 2

** Blockers

None.

* Session Continuity

- *Last action* :: [2026-02-26 Thu] -- Planning docs updated to reflect React
  19 + TanStack Query + Storybook + Playwright stack decisions; Phase 1 plans
  revised (01-02 and 01-03 updated); all changes committed
- *Next action* :: Execute Phase 1 -- run plans 01-01, 01-02, 01-03 in order
  (or waves 1 then 2); start with a fresh context window (~~/clear~~)
- *Context for next session* :: Phase 1 is pure setup -- no feature code.
  Focus: ADR infrastructure (01-01, wave 1), Vitest + React + TanStack
  install with jsdom (01-02, wave 1), then five ADRs 0001--0005 (01-03,
  wave 2). The executor should read the plan files and follow them exactly.
  All file writes must use ~mcp_bash~ heredoc syntax (Edit/Write tools may
  be blocked by plan-mode rules).

---
/STATE initialized: [2026-02-25 Tue]/
/Updated: [2026-02-26 Thu] -- React 19 + TanStack Query stack confirmed; ADR numbering locked; Phase 1 plans revised/
