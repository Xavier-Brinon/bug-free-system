#+title: State: BookTab
#+author: BookTab
#+date: [2026-02-25 Tue]
#+startup: indent
#+options: toc:2 num:nil ^:{}

* Project Reference

- *Core Value* :: Every new tab is a reminder of what you're reading and
  what's next — keeping your reading life visible without leaving the browser.
- *Current Focus* :: Phase 2 -- Extension Scaffold
- *Stack* :: TypeScript 5.9.3 + Vite 7.3.1 + =vite-plugin-web-extension= +
  React 19 + ~@xstate/react~ + XState v5 + TanStack Query +
  ~browser.storage.local~ + Vitest browser mode (Playwright/Chromium) +
  =vitest-browser-react= + Storybook + Playwright/Chromium
- *Target* :: React SPA delivered as a Firefox extension (Manifest V3) — the
  extension is a thin shell; the app is a standard React SPA in the new tab page
- *ADRs* :: =docs/decisions/= (MADR 4.0 structure, org-mode format)

See: [[file:PROJECT.org][PROJECT.org]] (updated [2026-02-26 Thu])

* Current Position

#+CAPTION: Current position
| Field            | Value                              |
|------------------+------------------------------------|
| Current Phase    | Phase 2: Extension Scaffold        |
| Current Plan     | 02-01 (planned, not started)       |
| Phase Status     | Planned (5 plans, 4 waves)         |
| Overall Progress | 1/6 phases complete                |

#+BEGIN_EXAMPLE
Progress: [████░░░░░░░░░░░░░░░░] 17%
Phase 1 [████] → Phase 2 [░░░░] → Phase 3 [░░░░] → Phase 4 [░░░░] → Phase 5 [░░░░] → Phase 6 [░░░░]
#+END_EXAMPLE

* Phase Summary

#+CAPTION: Phase summary
| Phase | Name                        | Requirements            | Status      |
|-------+-----------------------------+-------------------------+-------------|
|     1 | Tooling & Practice          | ADR-01--03, DEV-01--06  | Complete    |
|     2 | Extension Scaffold          | CORE-01--04             | Not started |
|     3 | Library CRUD                | LIB-01--04              | Not started |
|     4 | New Tab Display             | DISP-01--03             | Not started |
|     5 | Queue                       | QUEUE-01--02            | Not started |
|     6 | Data Safety                 | DATA-01--03             | Not started |

* Performance Metrics

#+CAPTION: Project metrics
| Metric           | Value  |
|------------------+--------|
| Phases complete  | 1 / 6  |
| Requirements met | 9 / 25 |
| Plans executed   | 3      |
| ADRs written     | 6      |
| Tests passing    | 0      |

* Accumulated Context

** Architectural decisions (pre-ADR)

- *Storage* :: ~browser.storage.local~ only -- never =window.localStorage=
  (wiped on privacy clear)
- *Manifest* :: V3 (Firefox 109+) -- no service workers; event pages are fine
- *UI layer* :: React 19 -- chosen over Vanilla TS because UI complexity spans
  4--6 views, stateful forms, and XState/TanStack Query integration; ADR-0003
  written in Phase 1 before scaffold begins
- *Async storage* :: TanStack Query wraps ~browser.storage.local~ -- provides
  loading/error/success states and cache invalidation via
  ~browser.storage.onChanged~; ADR-0004 written in Phase 1
- *State management* :: XState v5 machines/actors for ALL stateful logic;
  ~@xstate/react~ (~useMachine~, ~useSelector~) bridges to React; ADR-0007
  written in Phase 2 before any machine code
- *No background script* :: architecture is single privileged page (new tab)
  with direct storage access
- *Book metadata API* :: Open Library only -- no API key = no key exposure in
  extension source; ADR-0009 written in Phase 3 before search is implemented
- *Data structure* :: =booktab_data= key →
  ~{ schemaVersion, books: Record<id, BookRecord>, settings }~
- *Component isolation* :: Storybook (Vite builder, React framework) --
  ADR-0005 written in Phase 1; installation in Phase 2 when first component exists
- *E2E testing* :: Playwright / Chromium only -- Playwright cannot load
  extensions in its Firefox build; ADR-0006 written in Phase 2 before E2E scaffold
- *Documentation* :: All docs in org-mode; ADRs follow MADR 4.0 structure in
  =docs/decisions/= as =.org= files

** Critical pitfalls (pre-empt in Phase 2)

1. *CSP blocks inline JS / CDN scripts* -- all handlers via
   ~addEventListener()~, all JS in =.js= files
2. =window.localStorage= *wiped on privacy clear* -- use
   ~browser.storage.local~ exclusively
3. *Async race on new tab open* -- show loading state until
   ~storage.get()~ resolves; TanStack Query handles loading/error/success
   states; gate writes behind =storageReady=
4. *Flat unversioned export schema* -- =schemaVersion: 1= in schema from
   day one; migration layer before any schema change ships
5. *Open Library rate limits* -- 400--600ms debounce, =User-Agent= header,
   both =openlibrary.org= + =covers.openlibrary.org= in =host_permissions=
6. *Destructive import without warning* -- auto-backup before import;
   confirmation dialog; schema validation before write
7. *Playwright + Firefox* -- Playwright cannot load extensions in its Firefox
   build; E2E smoke tests run in Chromium proxy via
   ~chromium.launchPersistentContext()~; manual Firefox acceptance testing
   required

** File format conventions

All project documentation is written in org-mode format (=.org= files).

*Exception -- GSD workflow artefacts:* The =.planning/phases/= directory
contains files ending in =-PLAN.md= and =-SUMMARY.md=. These use the ~.md~
extension because the GSD tooling (=gsd-tools.cjs=) hardcodes
~endsWith('-PLAN.md')~ and ~endsWith('-SUMMARY.md')~ when scanning for plans
and summaries. Renaming them to =.org= would break plan discovery, wave
execution, and progress tracking.

These files are GSD tooling artefacts, not project documentation. Their
content uses YAML frontmatter + XML task blocks (the GSD format). Do not
convert them to org-mode.

All other files -- =REQUIREMENTS.org=, =ROADMAP.org=, =STATE.org=,
=PROJECT.org=, =docs/decisions/*.org=, =CONTRIBUTING.org= -- are org-mode.

** Developer practice rules (locked in Phase 1)

- Every phase begins with a tidy-up step (refactoring/cleanup before new
  feature code)
- *ADR before implementation, at any phase* -- an ADR is written immediately
  before implementing any architecturally significant decision, at whatever
  phase that decision arises. If a decision is later revised, a new ADR
  is written that supersedes the previous one (old ADR status set to
  "Superseded by NNNN"). The history is never rewritten -- only extended.
  This creates a complete, honest decision log for learning purposes.
- TDD: red-green-refactor vertical slicing -- one test → one implementation
  → repeat
- No tests written in bulk after implementation
- Tests exercise public interfaces only -- no internal mocking, no
  implementation detail testing
- All ADRs include Mermaid diagrams (ob-mermaid syntax, =:file= header
  required) when the decision involves a flow, state transition, dependency
  graph, or data structure

** ADR log (running -- updated as decisions are made)

| ADR    | Decision                           | Phase written | Status  |
|--------+------------------------------------+---------------+---------|
| 0001   | Vitest as test framework (jsdom)   | 1             | Superseded by 0012 |
| 0002   | TDD red-green-refactor methodology | 1             | Written |
| 0003   | React 19 as UI rendering layer     | 1             | Written |
| 0004   | TanStack Query for async storage   | 1             | Written |
| 0005   | Storybook for component isolation  | 1             | Written |
| 0006   | Playwright / Chromium for E2E      | 2             | Pending |
| 0007   | XState v5 state management         | 2             | Pending |
| 0008   | browser.storage.local only         | 2             | Pending |
| 0009   | Open Library API                   | 3             | Pending |
| 0010   | Versioned JSON export schema       | 6             | Pending |
| 0012   | Vitest browser mode (supersedes 0001) | 1          | Written |

** Open questions

- [ ] Does =unlimitedStorage= permission trigger a user-facing warning in
  Firefox? Evaluate in Phase 6 before AMO submission.
- [ ] What are Open Library's actual rate limit enforcement behaviours for a
  single-user extension? Test live in Phase 3.

** Todos

- [X] Initialize =docs/decisions/= with MADR 4.0 template (org-mode) -- Phase 1 (Plan 01-01)
- [X] Write CONTRIBUTING.org with locked practice rules -- Phase 1 (Plan 01-01)
- [X] Install Vitest + React + TanStack + testing-library -- Phase 1 (Plan 01-02)
- [X] Configure jsdom environment in vitest.config.ts -- Phase 1 (Plan 01-02)
- [X] Write ADR-0001 (Vitest) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0002 (TDD) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0003 (React 19) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0004 (TanStack Query) -- Phase 1 (Plan 01-03)
- [X] Write ADR-0005 (Storybook) -- Phase 1 (Plan 01-03)
- [ ] Write ADR-0006 (Playwright / Chromium) -- Phase 2, before E2E scaffold
- [ ] Write ADR-0007 (XState v5) -- Phase 2, before machine code
- [ ] Write ADR-0008 (browser.storage.local) -- Phase 2, before storage layer
- [ ] Write ADR-0009 (Open Library API) -- Phase 3, before search feature
- [ ] Write ADR-0010 (Versioned JSON export schema) -- Phase 6, before export feature
- [ ] Scaffold extension with =vite-plugin-web-extension= -- Phase 2
- [ ] Lock data schema in =schema.ts= before any feature code -- Phase 2

** Blockers

None.

* Session Continuity

- *Last action* :: [2026-02-26 Thu] -- Phase 2 planned: 5 plans across 4 waves.
  Architecture clarified (React SPA in extension shell). ADR-0012 written
  (Vitest browser mode supersedes ADR-0001 jsdom).
- *Next action* :: Execute Phase 2 starting with Plan 02-01 (tidy-up + 3 ADRs).
- *Context for next session* :: Phase 2 plans are written in
  =.planning/phases/02-extension-scaffold/=. Execute in wave order: 02-01
  (Wave 1: tidy-up + ADRs), then 02-02 + 02-03 (Wave 2: scaffold + schema),
  then 02-04 (Wave 3: XState), then 02-05 (Wave 4: Storybook + Playwright).
  Plans 02-03 and 02-04 require TDD. The tidy-up in 02-01 should be trivial.

---
/STATE initialized: [2026-02-25 Tue]/
/Updated: [2026-02-26 Thu] -- Phase 1 complete: 3 plans executed, 5 ADRs written, Vitest + React configured/
